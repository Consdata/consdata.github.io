I"·–<p>Trudno dziÅ› wyobraziÄ‡ sobie branÅ¼Ä™ IT bez chmury obliczeniowej. Przeniesienie naszych serwerÃ³w do clouda i zastosowanie Infrastructure as Code (IaC) pozwala czÄ™sto na zoptymalizowanie kosztÃ³w, a takÅ¼e na zapewnienie lepszej dostÄ™pnoÅ›ci i skalowalnoÅ›ci rozwiÄ…zania. Architektura serverless przenosi nas jeszcze poziom wyÅ¼ej - przestajemy myÅ›leÄ‡ o maszynach wirtualnych, skupiamy siÄ™ na kodzie rozwiÄ…zujÄ…cym konkretne potrzeby biznesowe. Wymusza ona rÃ³wnieÅ¼ pewnÄ… zmianÄ™ mentalnÄ… w Å›rodowisku inÅ¼ynierÃ³w IT - praca z arkuszem kalkulacyjnym i liczenie kosztÃ³w przygotowywanego rozwiÄ…zania staje siÄ™ nieodÅ‚Ä…cznÄ… czÄ™Å›ciÄ… procesu produkcji. Wraz z wprowadzeniem przez Amazon usÅ‚ugi AWS Lambda w 2014 roku programowanie w architekturze serverless staÅ‚o siÄ™ jeszcze prostsze. W artykule przedstawiÄ™ przykÅ‚ad serwisu do przechowywania notatek, przygotowany w oparciu o architekturÄ™ serverless, dostarczanÄ… przez AWS. PokaÅ¼Ä™ rÃ³wnieÅ¼ koszty takiego rozwiÄ…zania.</p>

<p>Wymagania biznesowe:</p>
<ul>
  <li>UÅ¼ytkownik moÅ¼e zapisywaÄ‡ notatki tekstowe.</li>
  <li>UÅ¼ytkownik moÅ¼e pobraÄ‡ zapisane wczeÅ›niej notatki tekstowe.</li>
</ul>

<p>Åšrodowisko deweloperskie:</p>
<ul>
  <li>Potrzebne bÄ™dzie aktywne konto w Amazon AWS. ZaÅ‚oÅ¼enie takiego konta jest doÅ›Ä‡ proste i dla wiÄ™kszoÅ›ci usÅ‚ug darmowe przez pierwszy rok uÅ¼ytkowania. Konto moÅ¼emy zaÅ‚oÅ¼yÄ‡ tutaj: <a href="https://aws.amazon.com/free">https://aws.amazon.com/free</a>. Podczas tworzenia konta konieczne jest podanie danych karty kredytowej, ale przy okazji tworzenia opisanego tu serwisu bÄ™dziemy uÅ¼ywali jedynie usÅ‚ug wchodzÄ…cych w skÅ‚ad rocznego free tier. W kaÅ¼dym momencie istnieje rÃ³wnieÅ¼ moÅ¼liwoÅ›Ä‡ sprawdzenia jakie sÄ… nasze naleÅ¼noÅ›ci dla Amazona. Niestety nie ma moÅ¼liwoÅ›ci ustalenia granicy kwotowej, ktÃ³rej nie chcemy przekroczyÄ‡, po ktÃ³rej nastÄ…pi wyÅ‚Ä…czenie naszej usÅ‚ugi. MoÅ¼na za to zdefiniowaÄ‡ alerty, ktÃ³re powiadomiÄ… nas w przypadku przekroczenia ustalonej naleÅ¼noÅ›ci. KonfigurujÄ…c konto w AWS warto wÅ‚Ä…czyÄ‡ Multi-Factor Authentication (MFA), ustrzeÅ¼e nas to przed najgorszym moÅ¼liwym scenariuszem, czyli przejÄ™ciem konta przez nieuprawnionÄ… osobÄ™. To moÅ¼e pociÄ…gnÄ…Ä‡ za sobÄ… spore koszty obciÄ…Å¼ajÄ…ce nasz rachunek.</li>
</ul>

<h2 id="implementacja-odczytu-notatek">Implementacja odczytu notatek</h2>
<h3 id="warstwa-persystencji">Warstwa persystencji</h3>
<p>Aby zaimplementowaÄ‡ odczyt notatek bÄ™dziemy potrzebowali jakÄ…Å› warstwÄ™ persystencji, gdzie przechowywane bÄ™dÄ… dane naszych notatek, komponent ktÃ³ry wystawi nam restowe API i coÅ› w czym zaimplementujemy â€œlogikÄ™ biznesowÄ…â€ reagujÄ…cÄ… na wywoÅ‚anie API pobraniem danych z warstwy persystencji.</p>

<p>AWS udostÄ™pnia warstwÄ™ persystencji na rÃ³Å¼ne sposoby. Mamy do dyspozycji storage plikowy S3, bazy relacyjne RDS a takÅ¼e bazÄ™ NoSql DynamoDB. JeÅ¼eli chcemy byÄ‡ w 100% serverless, nie uÅ¼ywamy RDS, gdyÅ¼ wymaga ona utrzymywania ciÄ…gle dziaÅ‚ajÄ…cej instancji (nadal nie musimy siÄ™ w tym przypadku przejmowaÄ‡ vmâ€™kami - baza jest uruchamiana jako niezaleÅ¼ny serwis, ale pÅ‚acimy za caÅ‚y czas, w ktÃ³rym dostÄ™pna jest baza). Do naszego zastosowania dobrze nadaje siÄ™ baza DynamoDB. Aby utworzyÄ‡ instancjÄ™ bazy, logujemy siÄ™ do konsoli AWS <a href="https://aws.amazon.com/console/">https://aws.amazon.com/console/</a> i przechodzimy do serwisu DynamoDB. Zanim utworzymy jakikolwiek zasÃ³b w konsoli AWS waÅ¼ne jest okreÅ›lenie regionu, w ktÃ³rym chcemy dziaÅ‚aÄ‡. Mapa przedstawia jakie regiony sÄ… dostÄ™pne (pomaraÅ„czowe okrÄ™gi) i ile â€œavailability zonesâ€ znajduje siÄ™ w kaÅ¼dym regionie. Zielone okrÄ™gi oznaczajÄ… dodatkowe regiony, ktÃ³re bÄ™dÄ… dostÄ™pne w przyszÅ‚oÅ›ci.</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/1.png" alt="Regiony" /></p>

<p>Najlepiej wybraÄ‡ region, znajdujÄ…cy siÄ™ najbliÅ¼ej lokalizacji, dla ktÃ³rej oferujemy nasze rozwiÄ…zanie (mniejsze opÃ³Åºnienia w komunikacji). Wszystkie komponenty skÅ‚adajÄ…ce siÄ™ na nasze rozwiÄ…zanie powinny w miarÄ™ moÅ¼liwoÅ›ci znajdowaÄ‡ siÄ™ w tym samym regionie. MoÅ¼liwa jest oczywiÅ›cie komunikacja, miÄ™dzy rÃ³Å¼nymi regionami, ale pociÄ…ga to za sobÄ… dodatkowe koszty. Region wybieramy klikajÄ…c nazwÄ™ miasta w prawym gÃ³rnym rogu konsoli:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/2.png" alt="WybÃ³r regionu" /></p>

<p>Po wybraniu regionu klikamy przycisk â€œCreate tableâ€ i przechodzimy do widoku tworzenia tabeli. Tutaj musimy okreÅ›liÄ‡ nazwÄ™ tabeli, np.: â€œnotesâ€ oraz klucz. Klucz tabeli DynamoDB moÅ¼e skÅ‚adaÄ‡ siÄ™ z jednej lub dwÃ³ch kolumn. Pojedynczy klucz zawiera tylko tzw. partition key - kolumna, ktÃ³rÄ… wybierzemy bÄ™dzie uÅ¼ywana do rozkÅ‚adu danych w rÃ³Å¼nych partycjach bazy danych. WybierajÄ…c partition key pamiÄ™tajmy, Å¼e poÅ¼Ä…dane jest, aby podczas dziaÅ‚ania systemu odwoÅ‚ywaÄ‡ siÄ™ do rÃ³Å¼nych partycji - to zapewnia lepsze skalowanie. W przypadku aplikacji do przechowywania notatek dobrym wyborem wydaje siÄ™ nazwa uÅ¼ytkownika. Nie moÅ¼emy jednak poprzestaÄ‡ na jednoczÄ™Å›ciowym kluczu, gdyÅ¼ moglibyÅ›my zapisaÄ‡ tylko jednÄ… notatkÄ™ dla uÅ¼ytkownika - podobnie jak w RDS wartoÅ›ci klucza muszÄ… byÄ‡ unikalne. Dodamy wiÄ™c drugÄ… czÄ™Å›Ä‡ klucza tzw. sort key. W naszym przypadku bÄ™dzie to timestamp dodania notatki:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/3.png" alt="WybÃ³r klucza" /></p>

<p>WybÃ³r klucza tabeli jest bardzo istotnym krokiem - decyzja jest wiÄ…Å¼Ä…ca i pÃ³Åºniej nie moÅ¼na zmieniÄ‡ juÅ¼ klucza. Co waÅ¼ne, wyszukiwanie w tabeli DynamoDB moÅ¼liwe jest jedynie po kluczu lub indeksie. W innym przypadku wyszukiwanie realizowane jest jako scan tabeli. Warto tu napisaÄ‡, Å¼e indeksy wyglÄ…dajÄ… inaczej niÅ¼ indeksy w relacyjnej bazie danych. Indeks w DynamoDB jest de facto kopiÄ… tabeli (okreÅ›lamy nawet jakie kolumny znajdÄ… siÄ™ w kopii i jedynie one bÄ™dÄ… dostÄ™pne dla wyszukanego rekordu). Kopia ta jest synchronizowana w sposÃ³b asynchroniczny! z oryginalnÄ… tabelÄ…. Przy okazji: DynamoDB zapewnia transakcyjnoÅ›Ä‡ jedynie na poziomie pojedynczego wiersza tabeli - moÅ¼liwe sÄ… tzw. conditional updates, czyli modyfikacja wiersza jeÅ¼eli speÅ‚nia on okreÅ›lone kryteria. Klasyczna transakcyjnoÅ›Ä‡ typu przelew z konta A na konto B nie jest wspierana!</p>

<p>W tej chwili dodamy kilka rekordÃ³w do naszej tabeli, aby moÅ¼liwe byÅ‚o przetestowanie funkcjonalnoÅ›ci odczytu notatek. Przechodzimy na zakÅ‚adkÄ™ items i klikamy przycisk â€œCreate itemâ€. Wpisujemy nazwÄ™ uÅ¼ytkownika oraz timestamp. Dodajemy rÃ³wnieÅ¼ nowÄ… kolumnÄ™ o nazwie â€œcontentâ€ i typie â€œStringâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/4.png" alt="Dodawanie rekordÃ³w" /></p>

<p>Wpisujemy przykÅ‚adowÄ… treÅ›Ä‡ notatki. Dodajmy jeszcze kilka przykÅ‚adowych notatek:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/5.png" alt="Wpisanie treÅ›ci notatki" /></p>

<h2 id="logika-biznesowa">Logika biznesowa</h2>
<p>WarstwÄ™ persystencji mamy gotowÄ…, zajmiemy siÄ™ teraz czÄ™Å›ciÄ… biznesowÄ…. Zaimplementujemy jÄ… w postaci lambd udostÄ™pnianych przez AWS. Wybieramy w lewym gÃ³rnym rogu konsoli Services i przechodzimy do serwisu Lambda. Tutaj klikamy przycisk â€œCreate a functionâ€ i przechodzimy do okreÅ›lania parametrÃ³w naszej lambdy. OkreÅ›lamy nazwÄ™ funkcji np.:â€getNotesâ€ oraz wybieramy jÄ™zyk, w ktÃ³rym tworzona jest nasza funkcja. Do wyboru mamy C#, JavÄ™ 8, Node.js 4.3, Node.js 6.10, Python 2.7, Python 6.10. Wybieramy Node.js 6.10.</p>

<p>Za wyborem jÄ™zyka idÄ… nie tylko okreÅ›lone cechy danego jÄ™zyka, ale takÅ¼e sposÃ³b jego dziaÅ‚ania w AWS. PrzykÅ‚adowo implementacja w Javie bÄ™dzie zdecydowanie najszybciej dziaÅ‚ajÄ…cym kodem na AWS, z drugiej jednak strony powoÅ‚anie nowej instancji lambdy napisanej w Javie bÄ™dzie trwaÅ‚o doÅ›Ä‡ dÅ‚ugo, bo aÅ¼ kilka sekund. Przy zaÅ‚oÅ¼eniu, Å¼e nasz system bÄ™dzie doÅ›wiadczaÅ‚ peekâ€™Ã³w wywoÅ‚aÅ„ moÅ¼e to oznaczaÄ‡, Å¼e w jednym momencie AWS bÄ™dzie prÃ³bowaÅ‚ zainstancjonowaÄ‡ tysiÄ…c (w zaleÅ¼noÅ›ci od liczby jednoczesnych wywoÅ‚aÅ„) lambd w tym samym czasie, a dalej przeÅ‚oÅ¼y siÄ™ to na kilkusekundowe opÃ³Åºnienie w realizacji tych requestÃ³w. BÄ™dziemy musieli rÃ³wnieÅ¼ ponieÅ›Ä‡ koszt za czas jaki zostaÅ‚ poÅ›wiÄ™cony na wystartowanie kaÅ¼dej instancji lambdy. Analogiczny przypadek dla lambd zaimplementowanych w ktÃ³rymÅ› z jÄ™zykÃ³w skryptowych moÅ¼e mymagaÄ‡ znaczÄ…co mniejszej liczby instancji, gdyÅ¼ lambdy bÄ™dÄ… wczeÅ›niej dostÄ™pne do obsÅ‚ugi requestÃ³w (kilkaset milisekund w porÃ³wnaniu do kilku sekund). Ciekawe porÃ³wnianie szybkoÅ›ci dziaÅ‚ania dla poszczegÃ³lnych jÄ™zykÃ³w moÅ¼na znaleÅºÄ‡ na stronie: <a href="https://read.acloud.guru/comparing-aws-lambda-performance-when-using-node-js-java-c-or-python-281bef2c740f">https://read.acloud.guru/comparing-aws-lambda-performance-when-using-node-js-java-c-or-python-281bef2c740f</a>.</p>

<p>W polu Role wybieramy â€œCreate a custom roleâ€ i przechodzimy do tworzenia nowej roli dla tworzonej przez nas lambdy. Rola ta bÄ™dzie przydatna do definiowania uprawnieÅ„, ktÃ³re umoÅ¼liwiÄ… lambdzie dostÄ™p do rÃ³Å¼nych serwisÃ³w AWS. Pozostawiamy domyÅ›lnie wypeÅ‚nione wartoÅ›ci i klikamy przycisk Allow. NastÄ™pnie na ekranie tworzenia lambdy wybieramy w polu Existing role* utworzonÄ… przez nas rolÄ™, powinna to byÄ‡ rola o nazwie â€œlambda_basic_executionâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/6.png" alt="Tworzenie roli" /></p>

<p>Klikamy przycisk â€œCreate functionâ€. Funkcja zostaje utworzona, a my widzimy ekran konfiguracji utworzonej przez nas funkcji. W polu â€œFunction codeâ€ znajduje siÄ™ inlineâ€™owy edytor, w ktÃ³rym moÅ¼emy edytowaÄ‡ kod naszej lambdy.</p>

<p>OczywiÅ›cie tworzenie kodu w konsoli pozwala jedynie na tworzenie prostych funkcji. Bardziej skomplikowane lambdy tworzymy w zewnÄ™trznych narzÄ™dziach i uploadâ€™ujemy w postaci archiwÃ³w zip. W polu â€œCode entry typeâ€ wybieramy â€œUpload a .ZIP fileâ€.</p>

<p>Implementacja lambdy w Node.js 6.10 polega na implementacji trÃ³j-argumentowej funkcji. Pierwszy argument zawiera dane eventâ€™a, ktÃ³ry uruchomiÅ‚ lambdÄ™, drugi to informacje kontekstowe dot. Å›rodowiska uruchomieniowego, trzeci to metoda callbackowa pozwalajÄ…ca na zwrÃ³cenie wyniku lub zaraportowanie bÅ‚Ä™du. PoniÅ¼ej znajduje siÄ™ kod lambdy umoÅ¼liwiajÄ…cy pobieranie notatek z DynamoDB dla uÅ¼ytkownika przekazanego w argumencie event:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// doÅ‚Ä…czamy sdk AWS</span>
<span class="kd">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">aws-sdk</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">event=</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
    <span class="c1">// tworzymy instancjÄ™ DocumentClient, ktÃ³ra umoÅ¼liwia zapytanie bazy danych</span>
    <span class="kd">let</span> <span class="nx">documentClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">DynamoDB</span><span class="p">.</span><span class="nx">DocumentClient</span><span class="p">();</span>
    <span class="c1">// definicja parmetrÃ³w zapytania do bazy danych</span>
    <span class="c1">// szukamy rekordÃ³w, dla ktÃ³rych userName jest rÃ³wne userName przekazanemu w event</span>
    <span class="kd">let</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">TableName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">notes</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">KeyConditionExpression</span><span class="p">:</span> <span class="dl">'</span><span class="s1">userName = :userName</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">ExpressionAttributeValues</span><span class="p">:</span> <span class="p">{</span>
            <span class="dl">'</span><span class="s1">:userName</span><span class="dl">'</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">userName</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// wykonanie zapytania do bazy</span>
    <span class="nx">documentClient</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// w przypdaku bÅ‚Ä™du logujemy bÅ‚Ä…d i zwracamy bÅ‚Ä…d w funkcji callback</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// logujemy odpowiedÅº z bazy u zwracamy odpowiedÅº w funkcji callback</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>
<p>Po dodaniu kodu okreÅ›limy jeszcze kilka parametrÃ³w konfiguracyjnych lambdy. W polu â€œBasic settingâ€ okreÅ›lamy timeout dla wywoÅ‚ania lambdy, warto zauwaÅ¼yÄ‡, Å¼e maksymalny timeout to 5 minut, co oznacza, Å¼e Å¼adna lambda nie moÅ¼e wykonywaÄ‡ siÄ™ dÅ‚uÅ¼ej niÅ¼ 5 minut. Dodatkowo moÅ¼emy okreÅ›liÄ‡ rozmiar pamiÄ™ci i co ciekawe przekÅ‚ada siÄ™ to rÃ³wnieÅ¼ na moc procesora, ktÃ³rÄ… dostanie nasza lambda (rozmiar pamiÄ™ci przekÅ‚ada siÄ™ oczywiÅ›cie na koszt usÅ‚ugi). W polu concurrency moÅ¼emy okreÅ›liÄ‡ maksymalnÄ… liczbÄ™ instancji naszej lambdy.</p>

<p>Ten wprowadzony niedawno parametr ma bardzo waÅ¼ne znaczenie dla lambd napisanych w jÄ™zyku Java. Pozwala bowiem obejÅ›Ä‡ problem uruchomienia bardzo duÅ¼ej liczby instancji lambdy w przypadku peekâ€™u - spowolni obsÅ‚ugÄ™ wszystkich requestÃ³w (co i tak by nastÄ…piÅ‚o ze wzglÄ™du na dÅ‚ugi czas tworzenia nowej instancji lambdy w Javie), ale jednoczeÅ›nie pozwoli na zmniejszenie kosztÃ³w usÅ‚ugi - nastÄ™pne wywoÅ‚ania bÄ™dÄ… juÅ¼ dziaÅ‚aÅ‚y na zainstancjonowanych lambdach i bÄ™dÄ… szybkie.</p>

<p>Zapisujemy lambdÄ™ przyciskiem â€œSaveâ€. Teraz moÅ¼emy przetestowaÄ‡ napisany przez nas kod. Klikamy przycisk â€œTestâ€ i definiujemy jsonâ€™a, ktÃ³ry zostanie przekazany w evencie podczas uruchamiania naszej lambdy.</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"userName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user1"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>Po uruchomieniu testu powinniÅ›my otrzymaÄ‡ bÅ‚Ä…d oznaczajÄ…cy brak autoryzacji zdefiniowanej przez nas lambdy do odczytu danych z bazy DynamoDB:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/7.png" alt="Komunikat bÅ‚Ä™du" /></p>

<p>Aby nadaÄ‡ odpowiednie uprawnienia musimy przejÅ›Ä‡ do usÅ‚ugi IAM (Services-&gt;IAM). WybraÄ‡ z menu po lewej stronie â€œRolesâ€, a nastÄ™pnie wybraÄ‡ rolÄ™, ktÃ³rÄ… zdefiniowaliÅ›my podczas tworzenia lambdy (lambda_basic_execution). Klikamy przycisk â€œAttach policyâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/8.png" alt="Nadawanie uprawnieÅ„" /></p>

<p>W polu wyszukiwania â€œpolicy typeâ€ wpisujemy DynamoDB i po wyszukaniu doÅ‚Ä…czamy policy â€œAmazonDynamoDBFullAccessâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/9.png" alt="Dodanie polityki" /></p>

<p>Po ponownym wywoÅ‚aniu testu lambdy powinniÅ›my otrzymaÄ‡ w wyniku dane pobrane z bazy DanamoDB:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/10.png" alt="Ponowny test" /></p>

<h2 id="rest-api">Rest API</h2>

<p>Pozostaje nam udostÄ™pnienie naszego serwisu do notatek w formie API restowego. Komponent AWS, ktÃ³ry umoÅ¼liwi nam zrobienie tego to API Gateway. W konsoli AWS przechodzimy do Serices-&gt;API Gateway i po zaÅ‚adowaniu strony klikamy przycisk â€œGet startedâ€. W polu wyboru wybieramy New API i wpisujemy nazwÄ™ np.: â€œnotesâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/11.png" alt="Nowe API" /></p>

<p>Klikamy przycik â€œCreate APIâ€. W polu â€œActionsâ€ wybieramy â€œCreate Resourceâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/12.png" alt="Tworzenie API" /></p>

<p>W polu â€œResource Nameâ€ wpisujemy â€œuserNameâ€, a w â€œResource Pathâ€ â€œ{username}â€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/13.png" alt="Tworzenie zasobu" /></p>

<p>Klikamy przycisk â€œCreate Resourceâ€. BÄ™dÄ…c na nowoutworzonym resource z menu â€œActionsâ€ wybieramy â€œCreate Methodâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/14.png" alt="Tworzenie metody" /></p>

<p>Z listy rozwijanej wybieramy metodÄ™ GET i zatwierdzamy:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/15.png" alt="Tworzenie endpointu" /></p>

<p>W polu wyboru â€œIntegration typeâ€ wybieramy â€œLambda functionâ€. PoniÅ¼ej w polu â€œLambda regionâ€ wybieramy region, w ktÃ³rym utworzyliÅ›my lambdÄ™ getNotes. W polu â€œLambda Functionâ€ podajemy nazwÄ™ funkcji np.: â€œgetNotesâ€ (po wpisaniu pierwszej litery nazwa powinna siÄ™ podpowiedzieÄ‡):</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/16.png" alt="WybÃ³r lambdy" /></p>

<p>Klikamy przycisk â€œSaveâ€ i zatwierdzamy nadanie uprawnienia wykonywania lambdy (popup). PoniewaÅ¼ chcemy, aby nazwa uÅ¼ytkownika, dla ktÃ³rego chcemy pobraÄ‡ notatki przekazywana byÅ‚a w Å›cieÅ¼ce potrzebujemy jeszcze dodatkowej konfiguracji. Kliknij na link â€œIntegration Requestâ€. RozwiÅ„ â€œURL Path Parametersâ€ i kliknij â€œAdd pathâ€. W polu name wpisz â€œusernameâ€, w â€œmapped fromâ€ â€œmethod.request.path.usernameâ€ i zatwierdÅº:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/17.png" alt="Parametryzacja Å›cieÅ¼ki" /></p>

<p>RozwiÅ„ â€œBody Mapping Templatesâ€ i kliknij â€œAdd mapping templateâ€. W polu â€œContent-Typeâ€ wpisz â€œapplication/jsonâ€ i zatwierdÅº. W polu edycji dodaj mapowanie:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
   </span><span class="nl">"userName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$input.params('username')"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/18.png" alt="Mapowanie" /></p>

<p>Zapisz mapowanie przyciskiem â€œSaveâ€.</p>

<p>Kliknij w drzewie â€œResourcesâ€ metodÄ™ â€œGETâ€. Po prawej stronie powinien pojawiÄ‡ siÄ™ przepÅ‚yw danych Å‚Ä…czÄ…cy API Gateway i lambdÄ™. Kliknij przycisk â€œTestâ€ aby przetestowaÄ‡ konfiguracjÄ™ API Gateway. Jako parametr â€œ{username}â€ podaj â€œuser1â€ i kliknij przycisk â€œTestâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/19.png" alt="Test" /></p>

<p>API Gateway powinno zwrÃ³ciÄ‡ notatki znajdujÄ…ce siÄ™ w bazie danych DynamoDB:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/20.png" alt="Wynik dziaÅ‚ania" /></p>

<p>Aby wystawiÄ‡ naszÄ… usÅ‚ugÄ™ na Å›wiat musimy jeszcze wdroÅ¼yÄ‡ konfiguracjÄ™ API Gateway. W tym celu z menu â€œActionsâ€ wybieramy â€œDeploy APIâ€. W polu â€œDeployment stageâ€ wybieramy â€œ[New Stage]â€, w polu â€œStage nameâ€ wpisujemy nazwÄ™ naszego Å›rodowiska np.: â€œtestâ€ i klikamy przycisk â€œDeployâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/21.png" alt="Deploy API" /></p>

<p>Od tej chwili nasz serwis dostÄ™pny jest w sieci. Aktualnie nie jest on niczym zabezpieczony, wiÄ™c kaÅ¼dy znajÄ…cy jego adres moÅ¼e go wywoÅ‚aÄ‡. Aby sprawdziÄ‡ dziaÅ‚anie z zewnÄ™trznej aplikacji, przechodzimy na zakÅ‚adkÄ™ â€œExportâ€ i pobieramy jsonâ€™a dla postmana:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/22.png" alt="Pobranie kolekcji Postmana" /></p>

<p>PobranÄ… kolekcjÄ™ importujemy do Postmana. W Å›cieÅ¼ce wywoÅ‚ania zamieniamy â€œ:usernameâ€ na faktycznÄ… nazwÄ™ uÅ¼ytkownika i wysyÅ‚amy Å¼Ä…danie. W odpowiedzi powinniÅ›my dostaÄ‡ dane z bazy DynamoDB:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/23.png" alt="Zaimportowana kolekcja Postmana" /></p>

<p>DostÄ™p do logÃ³w moÅ¼liwy jest za pomocÄ… serwisu CloudWatch. Aby dotrzeÄ‡ do logÃ³w konkretnej lambdy naleÅ¼y wejÅ›Ä‡ na jej konfiguracjÄ™, np.: Lambda-&gt;Functions-&gt;getNotes i przejÅ›Ä‡ na zakÅ‚adkÄ™ â€œMonitoringâ€. Dalej na jednym z paneli klikamy link â€œJump to Logsâ€. W to samo miejsce moÅ¼emy rÃ³wnieÅ¼ dotrzeÄ‡ z poziomu serwisÃ³w: Services-&gt;CloudWatch-&gt;Logs.</p>

<h2 id="implementacja-zapisu-notatek">Implementacja zapisu notatek</h2>
<p>WarstwÄ™ persystencji mamy juÅ¼ przygotowanÄ… i ona nie wymaga Å¼adnych modyfikacji. Aby umoÅ¼liwiÄ‡ zapis notatek, musimy zaimplementowaÄ‡ dodatkowÄ… lambdÄ™. Tworzymy jÄ… w taki sam sposÃ³b jak lambdÄ™ do odczytu podajÄ…c innÄ… nazwÄ™, np.: addNote i wybierajÄ…c utworzonÄ… wczeÅ›niej rolÄ™ â€œlambda_basic_executionâ€. Kod lambdy powinien wyglÄ…daÄ‡ mniej wiÄ™cej tak:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">aws-sdk</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">event=</span><span class="dl">"</span><span class="p">,</span> <span class="nx">event</span><span class="p">);</span>
    <span class="c1">// tworzymy instancjÄ™ DocumentClient, ktÃ³ra umoÅ¼liwia wstawienie do bazy danych</span>
    <span class="kd">let</span> <span class="nx">documentClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">DynamoDB</span><span class="p">.</span><span class="nx">DocumentClient</span><span class="p">();</span>
    <span class="c1">// definicja parmetrÃ³w wstawienia do bazy</span>
    <span class="c1">// nazwÄ™ uÅ¼ytkownika i treÅ›Ä‡ notatki pobieramy z przekazanego event'a</span>
    <span class="kd">let</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">TableName</span><span class="p">:</span> <span class="dl">'</span><span class="s1">notes</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">Item</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">userName</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">userName</span><span class="p">,</span>
            <span class="na">timestamp</span><span class="p">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
            <span class="na">content</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">content</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// prÃ³ba wstawienia do bazy</span>
    <span class="nx">documentClient</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>
<p>Aby przetestowaÄ‡ lambdÄ™ definiujemy nowy event testowy w formie jsonâ€™a:</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"userName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"nowo dodana notatka"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>i klikamy przycisk test. Notatka powinna byÄ‡ zwrÃ³cona podczas pobierania notatek uÅ¼ytkownika â€œuser1â€.</p>

<p>Pozostaje jeszcze konfiguracja API Gateway. W tym celu wchodzimy na Services-&gt;API Gateway i odnajdujemy utworzone wczeÅ›niej API â€œnotesâ€. W drzewie â€œResourcesâ€ wybieramy â€œ/â€ i w menu â€œActionsâ€ wybieramy akcjÄ™ â€œCreate Methodâ€.</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/24.png" alt="Konfiguracja API Gateway" /></p>

<p>Z listy metod wybierramy â€œPOSTâ€ i zatwierdzamy wybÃ³r. W polu â€œIntegration typeâ€ wybieramy â€œLambda Functionâ€. OkreÅ›lamy region naszej lambdy i podajemy jej nazwÄ™ w polu â€œLambda Functionâ€:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/25.png" alt="Konfiguracja API Gateway" /></p>

<p>Klikamy przycisk â€œSaveâ€ i zatwierdzamy dodanie uprawnienia do funkcji. I to tyle z konfiguracji API Gateway. Podobnie jak w przypadku odczytu rÃ³wnieÅ¼ na zapisie moÅ¼emy przetestowaÄ‡ konfiguracjÄ™ API Gateway. Klikamy przycisk â€œTestâ€ i w polu â€œRequest Bodyâ€ podajemy treÅ›Ä‡ eventa:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/26.png" alt="Konfiguracja API Gateway" /></p>

<p>W odpowiedzi powinniÅ›my otrzymaÄ‡ status http 200, a nowododana notatka powinna byÄ‡ widoczna w pobieranych notatkach uÅ¼ytkownika â€œuser1â€. Aby nowa metoda byÅ‚a dostÄ™pna z zewnÄ…trz, naleÅ¼y zdeployowaÄ‡ jeszcze raz nasze api wybierajÄ…c z menu â€œActionsâ€ â€œDeploy APIâ€ i podaÄ‡ utworzony wczeÅ›niej stage â€œtestâ€. Teraz ponownie moÅ¼emy wyeksportowaÄ‡ konfiguracjÄ™ do postmana i wykonaÄ‡ test:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/27.png" alt="Test w Postmanie" /></p>

<p>Diagram uÅ¼ytych przez nas komponentÃ³w AWS wyglÄ…da nastÄ™pujÄ…co:</p>

<p><img src="/assets/img/posts/2018-01-17-aws-serverless-programming/28.png" alt="UÅ¼yte komponenty" /></p>

<h2 id="ile-to-kosztuje">Ile to kosztuje</h2>
<p>Praca w cloudzie AWS daje nam moÅ¼liwoÅ›Ä‡ dokÅ‚adnego policzenia kosztÃ³w naszego rozwiÄ…zania. Trzeba przy tym pamiÄ™taÄ‡ rÃ³wnieÅ¼ o tym, Å¼e AWS daje nam tzw. â€œFree tierâ€ czyli pewnÄ… pulÄ™ zasobÃ³w, ktÃ³ra jest dostÄ™pna bezkosztowo.</p>

<h3 id="koszty-dynamodb">Koszty DynamoDB</h3>
<p>I tak zaczynajÄ…c od warstwy persystencji na koszty DynamoDB skÅ‚adajÄ… siÄ™ koszty przestrzeni, ktÃ³re zajmujÄ… dane oraz koszty operacji odczytu i zapisu wykonywane w jednostce czasu. Przy kosztach zapisu i odczytu AWS posÅ‚uguje siÄ™ jednostkami:</p>
<ul>
  <li>RCU (read capacity unit) - jeden RCU umoÅ¼liwia wykonywanie dwÃ³ch odczytÃ³w na sekundÄ™,</li>
  <li>WCU (write capacity unit) - jeden WCU umoÅ¼liwia wykonywanie jednego zapisu na sekundÄ™.</li>
</ul>

<p>JeÅ¼eli nasza aplikacja obsÅ‚uguje ruch, w ktÃ³rym maksymalnie wykonywane sÄ… 2 odczyty na sekundÄ™ przez caÅ‚y czas jej dziaÅ‚ania to AWS naliczy opÅ‚atÄ™ za 1 RCU.</p>

<p>W przypadku DynamoDB Free Tier wynosi:</p>
<ul>
  <li>25 RCU,</li>
  <li>25 WCU,</li>
  <li>25 GB zaindeksowanych danych.
Oznacza to, Å¼e aplikacja generujÄ…ca 25 zapisÃ³w na sekundÄ™ i 50 odczytÃ³w na sekundÄ™, ktÃ³rej dane mieszczÄ… siÄ™ w 25 GB nie generuje kosztÃ³w. Free tier dla DynamoDB jest staÅ‚y, nie ma ograniczenia czasowego. Po przekroczeniu wartoÅ›ci Free tier koszt wynosi odpowiednio:</li>
  <li>1 RCU: $0.09 miesiÄ™cznie,</li>
  <li>1 WCU: $0.47 miesiÄ™cznie,</li>
  <li>1 GB: $0.25 miesiÄ™cznie.
SzczegÃ³Å‚y naliczania kosztÃ³w dla DynamoDB moÅ¼na znaleÅºÄ‡ na stronie <a href="https://aws.amazon.com/dynamodb/pricing/">https://aws.amazon.com/dynamodb/pricing/</a>.</li>
</ul>

<h3 id="koszty-lambdy">Koszty Lambdy</h3>
<p>W przypadku lambd pÅ‚acimy za liczbÄ™ wykonanych Å¼Ä…daÅ„ oraz za tzw. gigabajto-sekundy (GB-seconds). W konfiguracji lambdy moÅ¼emy okreÅ›liÄ‡ ile maksymalnie pamiÄ™ci chcemy jej przydzieliÄ‡. Minimalnie to 128 MB, maksimum 3008 MB. LiczbÄ™ GB-s zuÅ¼ytych przez lambdÄ™ okreÅ›lamy jako:
-liczba skonfigurowanej pamiÄ™ci w MB / 1024 * czas wykonania lambdy w sekundach (zaokrÄ…glony do 100 ms w gÃ³rÄ™).</p>

<p>Czas wykonania lambdy, za ktÃ³ry AWS naliczy nam opÅ‚atÄ™ jest zawsze podawany w logu po wykonaniu danej lambdy, np.:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPORT RequestId: 31aaeaec-ef26-11e7-9892-57823db0c303    Duration: 316.42 ms    Billed Duration: 400 ms Memory Size: 128 MB    Max Memory Used: 34 MB
</code></pre></div></div>
<p>W tym przypadku nasza lambda zuÅ¼yÅ‚a 128/1024 GB * 0.4 s = 0.125 GB * 0.4 s = 0.05 GB-s. Free tier dla lambd wynosi:</p>
<ul>
  <li>1 000 000 Å¼Ä…daÅ„ miesiÄ™cznie,</li>
  <li>400 000 GB-s miesiÄ™cznie.</li>
</ul>

<p>Po przekroczeniu tych wartoÅ›ci pÅ‚acimy:</p>
<ul>
  <li>za kaÅ¼de 1 000 000 Å¼Ä…daÅ„ $0.20,</li>
  <li>za 1 GB-s $0.00001667.
SzczegÃ³Å‚y moÅ¼emy znaleÅºÄ‡ na stronie <a href="https://aws.amazon.com/lambda/pricing/">https://aws.amazon.com/lambda/pricing/</a>.</li>
</ul>

<h3 id="koszty-api-gateway">Koszty API-Gateway</h3>
<p>Zdecydowanie najdroÅ¼szym komponentem, ktÃ³rego uÅ¼yliÅ›my w naszym przykÅ‚adzie jest API-Gateway. W tym przypadku pÅ‚acimy za liczbÄ™ Å¼Ä…daÅ„ oraz dane, ktÃ³re transferujemy przez api. Warstwa darmowa obejmuje 1 000 000 Å¼Ä…daÅ„ miesiÄ™cznie, ale jest dostÄ™pna przez pierwsze 12 miesiÄ™cy uÅ¼ywania API-Gateway. Po tym czasie koszty wyglÄ…dajÄ… nastÄ™pujÄ…co:</p>
<ul>
  <li>1 000 000 Å¼Ä…daÅ„: $3.70,</li>
  <li>pierwsze 10 TB transferowanych danych $0.09 za 1 GB,</li>
  <li>kolejne 40 TB transferowanych danych $0.085 za 1 GB,</li>
  <li>kolejne 100 TB transferowanych danych $0.07 za 1 GB,</li>
  <li>kolejne 350 TB transferowanych danych $0.05 za 1 GB.
SzczegÃ³Å‚y dot. kosztÃ³w API-Gateway dostÄ™pne sÄ… na stronie <a href="https://aws.amazon.com/api-gateway/pricing/">https://aws.amazon.com/api-gateway/pricing/</a>.</li>
</ul>

<h2 id="koszty-przykÅ‚adowej-aplikacji">Koszty przykÅ‚adowej aplikacji</h2>
<p>ProponujÄ™ teraz Ä‡wiczenie polegajÄ…ce na policzeniu kosztÃ³w przygotowanej przez nas aplikacji. ZaÅ‚Ã³Å¼my, Å¼e chcemy obsÅ‚ugiwaÄ‡ milion uÅ¼ytkownikÃ³w i kaÅ¼dy z nich bÄ™dzie zapisywaÅ‚ 10 notatek dziennie i odczytywaÅ‚ 30. ZakÅ‚adamy Å¼e jedna notatka ma wielkoÅ›Ä‡ 1 KB.</p>

<h3 id="koszty-dynamodb-1">Koszty DynamoDB</h3>
<p>Mamy wiÄ™c 1 000 000 uÅ¼ytkownikÃ³w zapisujÄ…cych 10 notatek kaÅ¼dego dnia. Policzmy ile zapisÃ³w na sekundÄ™ potrzebujemy:</p>
<ul>
  <li>1 000 000 uÅ¼ytkownikÃ³w * 10 notatek * 31 dni = 310 000 000 zapisywanych notatek miesiÄ™cznie,</li>
  <li>310 000 000 / (31 dni * 24h * 60m * 60s) = 310 000 000 / 2678400s = 116 zapisÃ³w na sekundÄ™,
czyli potrzebujemy 116 WCU.</li>
</ul>

<p>KaÅ¼dy z uÅ¼ytkownikÃ³w odczytuje 30 notatek kaÅ¼dego dnia:</p>
<ul>
  <li>1 000 000 uÅ¼ytkownikÃ³w * 30 notatek * 31 dni = 930 000 000 odczytywanych notatek miesiÄ™cznie,</li>
  <li>930 000 000 / (31 dni * 24h * 60m * 60s) = 930 000 000 / 2678400s = 348 odczytÃ³w na sekundÄ™,
poniewaÅ¼ jeden RCU pozwala na 2 odczyty na sekundÄ™ potrzebujemy 348 / 2 = 174 RCU.</li>
</ul>

<p>Maksymalna liczba notatek jakÄ… bÄ™dziemy przechowywaÄ‡ w systemie po upÅ‚ywie 1 roku to:</p>
<ul>
  <li>12 miesiÄ™cy * 310 000 000 notatek = 3 720 000 000 * 1 KB = 3720 GB danych.</li>
</ul>

<p>Koszty wyniosÄ… odpowiednio:</p>
<ul>
  <li>koszt zapisÃ³w, czyli WCU to 116 - 25 (free tier) = 91 WCU * $0.47 = $42.77 miesiÄ™cznie,</li>
  <li>koszt odczytÃ³w, czyli RCU to 174 - 25 (free tier) = 149 RCU * $0.09 = $13.41 miesiÄ™cznie,</li>
  <li>koszt przechowywania danych to 3720 GB * $0.25 = $930 miesiÄ™cznie.</li>
</ul>

<p>W sumie za uÅ¼ycie DynamoDB zapÅ‚acimy miesiÄ™cznie <strong>$986.18</strong>.</p>

<h3 id="koszty-lambd">Koszty lambd</h3>
<p>Lambda getNotes:</p>
<ul>
  <li>bÄ™dzie wywoÅ‚ywana 930 000 000 razy miesiÄ™cznie,</li>
  <li>moÅ¼emy odjÄ…Ä‡ od tej liczby 1 000 000 requestÃ³w (free tier),</li>
  <li>zostaje 929 000 000 requestÃ³w,</li>
  <li>za kaÅ¼dy 1 000 000 requestÃ³w pÅ‚acimy $0.20,</li>
  <li>w sumie mamy wiÄ™c 929 * $0.20 = $185.8 miesiÄ™cznie.</li>
</ul>

<p>Lambda addNote:</p>
<ul>
  <li>bÄ™dzie wywoÅ‚ywana 310 000 000 razy miesiÄ™cznie,</li>
  <li>koszt wynosi wiÄ™c 310 * $0.20 = $62 miesiÄ™cznie.</li>
</ul>

<p>OprÃ³cz opÅ‚at za liczbÄ™ requestÃ³w pÅ‚acimy jeszcze za gigabajto-sekundy. ZaÅ‚Ã³Å¼my w przybliÅ¼eniu, Å¼e wywoÅ‚anie lambdy odczytujÄ…cej bÄ™dzie mieÅ›ciÅ‚o siÄ™ w 100 ms, a lambdy zapisujÄ…cej w 200 ms.</p>

<p>Dla getNotes mamy wiÄ™c:</p>
<ul>
  <li>930 000 000 * 0.1s * 128 / 1024 MB = 11 625 000 GB-s,</li>
  <li>od tej wartoÅ›ci moÅ¼emy odjÄ…Ä‡ 400 000 GB-s (free tier),</li>
  <li>koszt wynosi: 11 225 000 GB-s * $0.00001667 = $187.12 miesiÄ™cznie.</li>
</ul>

<p>Odpowiednio dla addNote:</p>
<ul>
  <li>310 000 000 * 0.2s * 128 / 1024 MB = 7 750 000 GB-s,</li>
  <li>koszt wynosi 7 750 000 * $0.00001667 = $129.19 miesiÄ™cznie.</li>
</ul>

<p>Sumaryczny koszt lambd wynosi <strong>$316.31</strong> miesiÄ™cznie.</p>

<h3 id="koszty-api-gateway-1">Koszty API-Gateway</h3>
<p>Koszty API-Gateway podzielone sÄ… na koszty wykonanych Å¼Ä…daÅ„ oraz koszty transferu danych. MiesiÄ™cznie wykonujemy:</p>
<ul>
  <li>1 000 000 uÅ¼ytkownikÃ³w * (10 zapisÃ³w + 30 odczytÃ³w) * 31 dni = 1 240 000 000 wywoÅ‚aÅ„ API-Gateway,</li>
  <li>za 1 000 000 wywoÅ‚aÅ„ pÅ‚acimy $3.70, koszt wynosi wiÄ™c 1 240 * $3.70 = $4 588.</li>
</ul>

<p>Przy zaÅ‚oÅ¼eniu, Å¼e pojedyncza notatka ma Å›rednio 1 KB transferujemy:</p>
<ul>
  <li>1 000 000 uÅ¼ytkownikÃ³w * (10 zapisÃ³w + 30 odczytÃ³w) * 31 dni * 1KB = 1.24 TB danych,</li>
  <li>koszt transferu dla pierwszy 10 TB to $0.09 za 1 GB,</li>
  <li>koszt wynosi wiÄ™c 1 240 GB * $0.09 = $111.6 miesiÄ™cznie.</li>
</ul>

<p>W sumie koszty API-Gateway to <strong>$4 699.6</strong> miesiÄ™cznie.</p>

<h3 id="podsumowanie">Podsumowanie</h3>
<p>Przy przyjÄ™tych zaÅ‚oÅ¼eniach caÅ‚kowity koszt naszej przykÅ‚adowej aplikacji wyniesie <strong>$6 002.09</strong> miesiÄ™cznie. Wydaje siÄ™ to sporÄ… kwotÄ…, jeÅ¼eli jednak podzielimy to przez liczbÄ™ uÅ¼ytkownikÃ³w, dostajemy koszt okoÅ‚o $0.006 na jednego uÅ¼ytkownika miesiÄ™cznie. Wynika z tego, Å¼e roczne utrzymanie jednego uÅ¼ytkownika zamknie siÄ™ w $0.08 - jeÅ¼eli zaoferujemy uÅ¼ytkownikom cenÄ™ $0.99 za roczny dostÄ™p do usÅ‚ugi na jednym uÅ¼ytkowniku zarobimy $0.91 rocznie :-)</p>

<h2 id="wady-i-zalety-rozwiÄ…zania">Wady i zalety rozwiÄ…zania</h2>
<p>RozwiÄ…zanie oparte o AWS wydaje siÄ™ byÄ‡ doÅ›Ä‡ proste do wykonania, a takÅ¼e atrakcyjne cenowo. PÅ‚acimy tylko za faktyczne zuÅ¼ycie zasobÃ³w nie ma wiÄ™c niebezpieczeÅ„stwa, Å¼e w przypadku maÅ‚ego zainteresowania naszÄ… aplikacjÄ… poniesiemy straty zwiÄ…zane z kosztami utrzymania infrastruktury. Dodatkowo w standardzie dostajemy duÅ¼Ä… skalowalnoÅ›Ä‡ rozwiÄ…zania. Wady? - W takiej implementacji bardzo mocno uzaleÅ¼niamy siÄ™ od komponentÃ³w AWS, przeniesienie rozwiÄ…zania na innÄ… infrastrukturÄ™ wiÄ…Å¼e siÄ™ praktycznie z jego przepisaniem.</p>

<p>JuÅ¼ wkrÃ³tce na naszym blogu pojawi siÄ™ artykuÅ‚ omawiajÄ…cy automatyzacjÄ™ tworzenia zasobÃ³w na AWS w oparciu o narzÄ™dzie terraform. Zapraszamy.</p>
:ET