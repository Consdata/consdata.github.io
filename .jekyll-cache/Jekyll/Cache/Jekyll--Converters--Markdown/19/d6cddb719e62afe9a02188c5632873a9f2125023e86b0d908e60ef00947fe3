I""<p>Rankingi baz danych pokazujÄ…, Å¼e juÅ¼ dobrych kilka lat wÅ›rÃ³d baz typu NoSQL krÃ³luje MongoDB i nic nie wskazuje na to, aby miaÅ‚o siÄ™ to szybko zmieniÄ‡. Trudno siÄ™ temu dziwiÄ‡ - MongoDB jest dokumentowÄ… bazÄ… danych, ale oferuje duÅ¼o wiÄ™cej poza funkcjonalnoÅ›ciami dodawania i pobierania dokumentÃ³w.</p>

<p>Dysponujemy bogatym zestawem narzÄ™dzi do zapytaÅ„ w postaci mechanizmu agregacji. Mamy teÅ¼ moÅ¼liwoÅ›Ä‡ nasÅ‚uchiwania na zmiany danych w bazie poprzez strumieÅ„ zmian (<em>change stream</em>). MoÅ¼emy rÃ³wnieÅ¼ walidowaÄ‡ schemat kolekcji poprzez dostarczony przez nas zestaw reguÅ‚. Wersja 4.0 MongoDB dostarcza transakcje obejmujÄ…ce wiÄ™cej niÅ¼ jeden dokument. JuÅ¼ wczeÅ›niejszy mechanizm transakcji na poziomie pojedyneczego dokumentu pozwala na tworzenie produkcyjnych aplikacji przy wykorzystaniu funkcji typu znajdÅº i usuÅ„, podmieÅ„ oraz zaktualizuj (<em>findOneAndDelete</em>, <em>findOneAndReplace</em>, <em>findOneAndUpdate</em>). W tym przypadku musimy zaprojektowaÄ‡ odpowiedni schemat bazy.</p>

<p>DziÄ™ki shardingowi MongoDB pozwala przechowywaÄ‡ i przetwarzaÄ‡ ogromne iloÅ›ci danych bez znacznego spadku wydajnoÅ›ci. Poza tym dziÄ™ki redundancji w klastrze (<em>replica set</em>) dane sÄ… niemalÅ¼e zawsze dostÄ™pne. Co wiÄ™cej, dokumentacja MongoDB wprost mÃ³wi, Å¼e klaster z redundacjÄ… danych powinien byÄ‡ podstawÄ… kaÅ¼dej instalacji produkcyjnej.</p>

<p>KaÅ¼dy system jest rozwijany i zmienia siÄ™ w odpowiedzi na nowe wymagania biznesowe. Z tego powodu moÅ¼e siÄ™ zdarzyÄ‡, Å¼e konieczne bÄ™dÄ… zmiany w zapytaniach do bazy i co za tym idzie rÃ³wnieÅ¼ mogÄ… byÄ‡ wymagane zmiany indeksÃ³w. Staniemy wtedy przed wyzwaniem zmiany indeksÃ³w w systemie produkcyjnym. MoÅ¼e siÄ™ zdarzyÄ‡, Å¼e jeden okaÅ¼e siÄ™ niepotrzebny i bÄ™dziemy chcieli go usunÄ…Ä‡, aby zwolniÄ‡ miejsce. Drugi indeks trzeba bÄ™dzie stworzyÄ‡, aby przyspieszyÄ‡ wykonywanie nowych zapytaÅ„. Tworzenie indeksu moÅ¼e trwaÄ‡ bardzo dÅ‚ugo. Nie chcemy na ten czas wyÅ‚Ä…czaÄ‡ produkcji. PoniÅ¼szy tekst wyjaÅ›nia, jak stworzyÄ‡ nowy i usunÄ…Ä‡ stary indeks bez wiÄ™kszych zawirowaÅ„ na produkcji.</p>

<p>Aby caÅ‚a operacja odbyÅ‚a siÄ™ bez problemÃ³w, powinniÅ›my wykonaÄ‡ jÄ… w nastÄ™pujÄ…cej kolejnoÅ›ci:</p>
<ul>
  <li>utworzenie indeksu pod nowe zapytania w systemie;</li>
  <li>aktualizacja czÄ™Å›ci biznesowej systemu;</li>
  <li>usuniÄ™cie starego indeksu, o ile nie jest juÅ¼ uÅ¼ywany.</li>
</ul>

<h1 id="tworzenie-indeksu-w-mongodb-w-sposÃ³b-rolling">Tworzenie indeksu w MongoDB w sposÃ³b <em>rolling</em></h1>

<p>Tworzenie indeksu w sposÃ³b <em>rolling</em> dotyczy tylko i wyÅ‚Ä…cznie bazy z redundacjÄ… danych w klastrze. Ta metoda pozwala na tworzenie nieunikalnych indeksÃ³w. Przeprowadzana jest dla kaÅ¼dego wÄ™zÅ‚a w klastrze:</p>
<ul>
  <li>wÄ™zeÅ‚ jest odÅ‚Ä…czany od klastra i uruchamiany w trybie standalone;</li>
  <li>tworzony jest indeks na tym wÄ™Åºle;</li>
  <li>wÄ™zeÅ‚ jest doÅ‚Ä…czany do klastra.</li>
</ul>

<p>W czasie tworzenia indeksu pozostaÅ‚e wÄ™zÅ‚y klastra caÅ‚y czas dziaÅ‚ajÄ… produkcyjnie i co za tym idzie dane siÄ™ zmieniajÄ…. WÄ™zeÅ‚, ktÃ³ry byÅ‚ uruchomiony w trybie standalone, i na ktÃ³rym tworzony byÅ‚ indeks, po wÅ‚Ä…czeniu do klastra bÄ™dzie musiaÅ‚ siÄ™ zsynchronizowaÄ‡ i pobraÄ‡ wszytkie zmiany, ktÃ³re zaszÅ‚y w czasie, kiedy byÅ‚ odÅ‚Ä…czony. Aby caÅ‚a procedura odbyÅ‚a siÄ™ bez problemu, naleÅ¼y zapewniÄ‡, aby oplog miaÅ‚ odpowiedni rozmiar. Oplog przechowuje ostatnie zmiany danych, ktÃ³re zaszÅ‚y w wÄ™Åºle primary i jeÅ¼eli nie bÄ™dzie odpowiednio duÅ¼y, to wÄ™zeÅ‚ ktÃ³ry jest doÅ‚Ä…czany do klastra, nie bÄ™dzie w stanie siÄ™ zsynchronizowaÄ‡. WiÄ™cej informacji o tym, jak dobraÄ‡ rozmiar oplog jest w <a href="https://docs.mongodb.com/manual/core/replica-set-oplog/#replica-set-oplog-sizing">dokumentacji MongoDB</a>.</p>

<p>ProcedurÄ™ zaczynamy od wÄ™zÅ‚Ã³w secondary, a na koÅ„cu przeprowadzamy jÄ… dla wÄ™zÅ‚a primary. NaleÅ¼y zwrÃ³ciÄ‡ uwagÄ™ na <em>write concern</em>. PrzykÅ‚adowo jeÅ¼eli mamy klaster zÅ‚oÅ¼ony z 3 wÄ™zÅ‚Ã³w i write concern rÃ³wne 3, to z pukntu widzenia aplikacji baza bÄ™dzie niedostÄ™pna po odÅ‚Ä…czeniu wÄ™zÅ‚a. Wszystkie zapisy bÄ™dÄ… siÄ™ koÅ„czyÄ‡ bÅ‚Ä™dem.</p>

<h2 id="odÅ‚Ä…czenie-wÄ™zÅ‚a-od-klastra">OdÅ‚Ä…czenie wÄ™zÅ‚a od klastra</h2>

<p>OdÅ‚Ä…czenie wÄ™zÅ‚a od klastra wymaga 2 krokÃ³w:</p>
<ul>
  <li>zmiany w konfiguracji, aby wÄ™zeÅ‚ po restarcie nie podÅ‚Ä…czyÅ‚ siÄ™ do klastra,</li>
  <li>restartu wÄ™zÅ‚a.</li>
</ul>

<p>W konfiguracji musimy zmieniÄ‡ port, wykomentowaÄ‡ konfiguracjÄ™ repliki oraz wyÅ‚Ä…czyÄ‡ odÅ›wieÅ¼anie sesji. PrzykÅ‚adowo fragment pliku z konfiguracjÄ… moÅ¼e wyglÄ…daÄ‡ tak:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">net</span><span class="pi">:</span>
  <span class="na">bindIp</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">28017</span>
<span class="c1">#   port: 27017</span>
<span class="c1">#replication:</span>
<span class="c1">#   replSetName: rs0</span>

<span class="c1"># WyÅ‚Ä…cz odÅ›wieÅ¼anie sesji</span>
<span class="na">setParameter</span><span class="pi">:</span>
   <span class="na">disableLogicalSessionCacheRefresh</span><span class="pi">:</span> <span class="no">true</span>
</code></pre></div></div>

<p>Uwaga! JeÅ¼eli wÄ™zeÅ‚ jest primary, to musimy wykonaÄ‡ operacjÄ™ <em>step down</em> przed restartem, aby staÅ‚ siÄ™ secondary, a klaster wybraÅ‚ inny wÄ™zeÅ‚ jako primary. SÅ‚uÅ¼y temu polecenie <code class="language-plaintext highlighter-rouge">rs.stepDown()</code>.</p>

<p>Po zmianach w konfiguracji restartujemy wÄ™zeÅ‚. W tym momencie wÄ™zeÅ‚ jest odÅ‚Ä…czony od klastra i dziaÅ‚a w trybie standalone. Teraz moÅ¼emy utworzyÄ‡ indeks.</p>

<h2 id="tworzenie-indeksu">Tworzenie indeksu</h2>

<p>Po restarcie wÄ™zÅ‚a i uruchomieniu w trybie standalone, podÅ‚Ä…czamy siÄ™ do niego i wykonujemy polecenie tworzÄ…ce indeks zgodnie z <a href="https://docs.mongodb.com/manual/reference/method/db.collection.createIndex/">dokumentacjÄ…</a>. Tworzenie indeksu moÅ¼e okazaÄ‡ siÄ™ czasochÅ‚onne. Aktualnie wykonywane operacje na bazie sprawdzimy, uruchamiajÄ…c polecenie <code class="language-plaintext highlighter-rouge">db.currentOp()</code> w powÅ‚oce MongoDB. To pozwoli dowiedzieÄ‡ siÄ™, czy indeks nadal siÄ™ buduje.</p>

<h2 id="doÅ‚Ä…czenie-wÄ™zÅ‚a-do-klastra">DoÅ‚Ä…czenie wÄ™zÅ‚a do klastra</h2>

<p>Po zbudowaniu indeksu doÅ‚Ä…czamy wÄ™zeÅ‚ do klastra. Polega to na wycofaniu zmian w konfiguracji oraz restarcie wÄ™zÅ‚a. W tym momencie wÄ™zeÅ‚ bÄ™dzie siÄ™ aktualizowaÅ‚ wzglÄ™dem klastra (wÄ™zÅ‚a primary), czyli pobieraÅ‚ zmiany, ktÃ³re zaszÅ‚y w czasie kiedy byÅ‚ odÅ‚Ä…czony.</p>

<p>Informacje o klastrze sÄ… zwracane przez polecenia:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">rs.status()</code> - zwraca status klastra wzglÄ™dem wÄ™zÅ‚a, na ktÃ³rym polecenie zostaÅ‚o uruchomione;</li>
  <li><code class="language-plaintext highlighter-rouge">rs.printSlaveReplicationInfo()</code> - zwraca informacje o wÄ™zÅ‚ach secondary Å‚Ä…cznie z opÃ³Åºnieniem wzglÄ™dem wÄ™zÅ‚a primary.</li>
</ul>

<h1 id="usuwanie-indeksu">Usuwanie indeksu</h1>

<p>Procedura usuniÄ™cia indeksu zaleÅ¼y od wersji MongoDB. Od wersji 4.2 wystarczy usunÄ…Ä‡ indeks na wÄ™Åºle primary. CaÅ‚Ä… resztÄ…, czyli usuniÄ™ciem indeksu z wÄ™zÅ‚Ã³w secondary, zajmie siÄ™ baza. JeÅ¼eli pracujemy z wczeÅ›niejszÄ… wersjÄ…, to indeks naleÅ¼y usunÄ…Ä‡ podobnie jak tworzymy indeks w sposÃ³b rolling. JedynÄ… rÃ³Å¼nicÄ… jest to, Å¼e indeks usuwamy, a nie tworzymy.</p>

<p>W jednym i drugim przypadku musimy jednak siÄ™ upewniÄ‡, Å¼e Å¼adne zapytanie nie korzysta z danego indeksu. Inaczej zapytanie zakoÅ„czy siÄ™ bÅ‚Ä™dem.</p>

<h1 id="zarzÄ…dzanie-indeksami-a-automatyzacja">ZarzÄ…dzanie indeksami a automatyzacja</h1>

<p>Zazwyczaj chcemy uÅ‚atwiÄ‡ sobie Å¼ycie i wiele rzeczy automatyzujemy. MoÅ¼na rÃ³wnieÅ¼ siÄ™ pokusiÄ‡ o automatyczne usuwanie i tworzenie indeksÃ³w podczas wdraÅ¼ania kolejnej wersji systemu. DoÅ›wiadczenie pokazuje, Å¼e moÅ¼na pochopnie umieÅ›ciÄ‡ w skryptach dwa polecenia usuniÄ™cia i stworzenia indeksu na wÄ™Åºle primary. Najprawdopodobniej skoÅ„czy siÄ™ to powaÅ¼nym bÅ‚Ä™dem i jeÅ¼eli operacjÄ™ przeprowadzamy na produkcji, to produkcja bÄ™dzie niedostÄ™pna do czasu naprawy. Czas przestoju bÄ™dzie znaczÄ…cy, jeÅ¼eli kolekcja bÄ™dzie znaczÄ…cych rozmiarÃ³w.</p>

<p>Zmiany w indeksach powinniÅ›my przeprowadzaÄ‡ manualnie z planem dziaÅ‚ania w rÄ™ku.</p>

<h1 id="podsumowanie">Podsumowanie</h1>

<p>MongoDB jest dokumentowÄ… bazÄ… danych oferujÄ…cÄ… bogatÄ… funkcjonalnoÅ›Ä‡ i jednoczeÅ›nie na tyle elastycznÄ…, Å¼e pozwala przeprowadzaÄ‡ zadania administracyjne bez przerwy w dziaÅ‚aniu. To siÄ™ tyczy rÃ³wnieÅ¼ tworzenia oraz usuwania indeksÃ³w, co nie jest operacjÄ… trudnÄ….</p>
:ET