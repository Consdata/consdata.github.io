I"æ0<p>BieÅ¼Ä…ce informacje o stanie serwerÃ³w i dziaÅ‚ajÄ…cych na nich usÅ‚ug sÄ… waÅ¼ne dla kaÅ¼dego dostawcy rozwiÄ…zaÅ„ IT, z ktÃ³rego korzysta szersza rzesza uÅ¼ytkownikÃ³w. NajwaÅ¼niejsze oczywiÅ›cie jest zapewnienie, Å¼e wszystkie usÅ‚ugi dziaÅ‚ajÄ…. Jednak samo dziaÅ‚anie to jeszcze nie wszystko. WaÅ¼ny jest takÅ¼e czas odpowiedzi z tych usÅ‚ug. JeÅ›li czas odpowiedzi wzrÃ³sÅ‚, lub nawet usÅ‚uga przestaÅ‚a odpowiadaÄ‡, przydatna moÅ¼e okazaÄ‡ siÄ™ znajomoÅ›Ä‡ stanu maszyny w zadanym czasie. W tym celu przydatne bÄ™dÄ… takie dane, jak obciÄ…Å¼enie procesora w danym momencie, zuÅ¼ycie pamiÄ™ci RAM oraz wolnej przestrzeni na dysku. Aby moÅ¼liwie szybko zareagowaÄ‡, a byÄ‡ moÅ¼e takÅ¼e uniknÄ…Ä‡ sytuacji, w ktÃ³rej usÅ‚uga przestaje odpowiadaÄ‡, istotne sÄ… ostrzeÅ¼enia, ktÃ³re pozwolÄ… zareagowaÄ‡ na czas. Niniejszy artykuÅ‚ ma na celu zaprezentowaÄ‡ rozwiÄ…zanie, ktÃ³re pozwoli w miarÄ™ szybko stworzyÄ‡ system monitoringu oraz ostrzegania na systemach wyposaÅ¼onych w system Linux, oparty o takie narzÄ™dzia jak â€œGrafanaâ€, â€œIcinga2â€ oraz â€œInfluxDBâ€.</p>
<div class="img-with-legend">
<img src="/assets/img/posts/2017-12-01-monitoring-serwerow-i-uslug/1.png" />
<span class="img-legend">PrzykÅ‚adowy dashboard prezentujÄ…cy stan maszyny (obciÄ…Å¼enie, zuÅ¼ycie ramu i dysku), jak i dziaÅ‚ajÄ…cych na nim usÅ‚ug</span>
</div>

<h2 id="wymagania-wstÄ™pne">Wymagania wstÄ™pne</h2>
<p>Na maszynie, ktÃ³ra peÅ‚niÄ‡ bÄ™dzie rolÄ™ serwera monitoringu naleÅ¼y:</p>
<ol>
  <li>ZainstalowaÄ‡ Dockera (<a href="https://docs.docker.com/engine/installation/">https://docs.docker.com/engine/installation/</a>)</li>
  <li>ZainstalowaÄ‡ Docker-Compose (<a href="https://docs.docker.com/compose/install/">https://docs.docker.com/compose/install/</a>)</li>
  <li>NaleÅ¼y upewniÄ‡ siÄ™, Å¼e sieci tworzone przez Dockera bÄ™dÄ… miaÅ‚y dostÄ™p do maszyn, ktÃ³re chcemy monitorowaÄ‡. Przypadkiem kiedy takiego dostÄ™pu moÅ¼e nie byÄ‡, jest sytuacja w ktÃ³rej monitorowane maszyny znajdujÄ… siÄ™ za sieciÄ… VPN. Jednym z rozwiÄ…zaÅ„ w takim przypadku, ktÃ³re odbywa siÄ™ kosztem sÅ‚abszej separacji kontenera od hosta, jest edycja pliku docker-compose.yml z punktu piÄ…tego niniejszego rozdziaÅ‚u, tak aby kontenery korzystaÅ‚y z sieci hosta.</li>
  <li>W kolejnym kroku powinniÅ›my wygenerowaÄ‡ parÄ™ kluczy SSH, ktÃ³ra posÅ‚uÅ¼y do uwierzytelniania siÄ™ na monitorowanych maszynach.</li>
  <li>Na sam koniec pozostaje pobranie nastÄ™pujÄ…cego projektu: <a href="https://github.com/aswarcewicz/monitoring">https://github.com/aswarcewicz/monitoring</a></li>
</ol>

<p>Na maszynach, ktÃ³re bÄ™dÄ… monitorowane naleÅ¼y dodaÄ‡ do zaufanych klucz publiczny SSH wygenerowany na serwerze monitoringu w kroku czwartym, tak aby serwer monitorujÄ…cy mÃ³gÅ‚ logowaÄ‡ siÄ™ przez SSH bez podawania hasÅ‚a. Logowanie przez SSH wykonywane jest celem pobrania stanu maszyny (obciÄ…Å¼enie, zuÅ¼ycie RAMu oraz dysku).</p>

<h2 id="uruchamiamy-kontenery">Uruchamiamy kontenery</h2>
<ol>
  <li>Po pobraniu projektu z githuba, naleÅ¼y umieÅ›ciÄ‡ klucz prywatny serwera wewnÄ…trz struktury pobranego projektu w katalogu â€œicinga2/ssh_keysâ€. Klucz prywatny zazwyczaj nosi nazwÄ™ id_rsa i nie posiada rozszerzenia *.pub.</li>
  <li>Tworzymy i uruchamiamy wszystkie kontenery nastÄ™pujÄ…cym poleceniem wykonanym wewnÄ…trz pobranego projektu: â€œdocker-compose upâ€</li>
  <li>W terminalu obok wykonujemy polecenie â€œdocker exec -it influxdb bashâ€, dziÄ™ki ktÃ³remu znajdziemy siÄ™ wewnÄ…trz kontenera influxdb.
    <ul>
      <li>W celu utworzenia bazy danych pod zbierane metryki uruchamiamy w kontenerze nastÄ™pujÄ…cy program â€œ/opt/influxdb/usr/bin/influxâ€</li>
      <li>NastÄ™pnie wykonujemy polecenie tworzÄ…ce bazÄ™ danych, ktÃ³ra bÄ™dzie przechowywaÅ‚a dane przez dwa tygodnie. DÅ‚ugoÅ›Ä‡ przechowywania danych moÅ¼na dobraÄ‡ dowolnie, w tym takÅ¼e pominÄ…Ä‡ ich usuwanie po zadanym czasie. â€œCREATE DATABASE icinga2 WITH DURATION 2wâ€. Po wykonaniu tego polecenia moÅ¼na juÅ¼ opuÅ›ciÄ‡ kontener influxdb.</li>
    </ul>
  </li>
  <li>W tym kroku naleÅ¼y przejÅ›Ä‡ do konfiguracji Icinga2, tak aby zapisywaÅ‚a zebrane dane do wczeÅ›niej utworzonej bazy InfluxDB. Uruchomienie polecenia z punktu drugiego stworzyÅ‚o w katalogu projektu folder o nazwie â€œdataâ€, wewnÄ…trz ktÃ³rego znajdujÄ… siÄ™ niezbÄ™dne konfiguracje oraz bazy danych. W celu konfiguracji Icinga2 naleÅ¼y wyedytowaÄ‡ plik â€œ./data/config/icinga2/features-enabled/influxdb.confâ€ tak, aby wskazywaÅ‚ na wÅ‚aÅ›ciwÄ… bazÄ™ danych. JeÅ›li korzystamy z sieci utworzonej przez dockera, w linijce odpowiedzialnej za hosta powinien znaleÅºÄ‡ siÄ™ wpis â€œinfluxdbâ€, gdyÅ¼ pod takim aliasem dostÄ™pny bÄ™dzie kontener z bazÄ…. Natomiast, jeÅ›li korzystamy z sieci hostâ€™a, w tej samej linijce powinien znaleÅºÄ‡ siÄ™ wpis localhost. PozostaÅ‚e linijki wystarczy odkomentowaÄ‡.</li>
  <li>Uruchamiamy ponownie caÅ‚oÅ›Ä‡. MoÅ¼na dokonaÄ‡ tego poprzez uÅ¼ycie kombinacji klawiszy â€œCTRL+Câ€ na terminalu z uruchomionym poleceniem â€œdocker-compose upâ€ lub poprzez uruchomienie innego terminala w katalogu projektu oraz wykonanie polecenia â€œdocker-compose stopâ€. Po zatrzymaniu kontenerÃ³w naleÅ¼y oczywiÅ›cie uruchomiÄ‡ je ponownie za pomocÄ… â€œdocker-compose upâ€ lub w tle â€œdocker-compose startâ€.</li>
</ol>

<h2 id="konfiguracja-zbierania-danych">Konfiguracja zbierania danych</h2>
<p>W tej czÄ™Å›ci skonfigurujemy IcingÄ™ tak, aby zbieraÅ‚a dane potrzebne dla naszego monitoringu. Wszystkie konfiguracje powinny znaleÅºÄ‡ siÄ™ w katalogu projektu â€œ./data/config/icinga2/conf.dâ€ lub w jego podkatalogach, aby zostaÅ‚y zaczytane przez IcingÄ™. Warto zwrÃ³ciÄ‡ uwagÄ™ na domyÅ›lnÄ… konfiguracjÄ™ komend zbierajÄ…cych dane o obciÄ…Å¼eniu, zuÅ¼yciu pamiÄ™ci RAM czy dysku. Komendy te domyÅ›lnie wykorzystujÄ… uÅ¼ytkownika â€œrootâ€ do logowania po SSH, jeÅ›li klucze wygnerowane w podpunkcie 4. â€œwymagaÅ„ wstÄ™pnychâ€ przeznaczone sÄ… dla innego uÅ¼ytkownika, to warto dokonaÄ‡ tej zmiany globalnie juÅ¼ w samej konfiguracji komend.</p>

<p>Aby rozpoczÄ…Ä‡ zbierane danych przez IcingÄ™ naleÅ¼y najpierw skonfigurowaÄ‡ usÅ‚ugi, przykÅ‚adowa konfiguracja poniÅ¼ej:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apply Service "router_version_https" {
  import "generic-service"
  display_name = "Router (version) - HTTPS"

  assign where "router" in host.vars.services
  ignore where host.vars.router.https.port == ""

  check_command = "http"
  vars.http_uri = "/router/version/getVersionNumber"
  vars.http_vhost = 
  vars.http_port = 
  vars.http_ssl = "true"
}

apply Service "servicemix_tcp_https" {
  import "generic-service"
  display_name = "ServiceMix - TCP (https)"

  assign where "router" in host.vars.services
  ignore where host.vars.router.https.port == ""
  check_command = "tcp"
  vars.tcp_address = 
  vars.tcp_port = 
}
</code></pre></div></div>
<p>A nastÄ™pnie dodaÄ‡ konfiguracjÄ™ maszyn (hostÃ³w), ktÃ³re z tych usÅ‚ug korzystajÄ…, przykÅ‚ad poniÅ¼ej:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>object Host "Consdata (formdev)" {
    import "generic-host"
    address = "formdev.eximee.consdata.local"

    vars.os = "Linux"
    vars.services = ["check-load", "check-memory", "check-disk-space", "router"]

    /* Router */
    vars.router.https.port = "9002"
}
</code></pre></div></div>
<p>Po ponownym uruchomieniu Icinga powinna zaczytaÄ‡ konfiguracjÄ™ i co okoÅ‚o 30 sekund zapisywaÄ‡ metryki do InfluxDB. Ewentualne problemy powinny znaleÅºÄ‡ siÄ™ w logach, do ktÃ³rych dostÄ™p moÅ¼na uzyskaÄ‡ poprzez komendÄ™ â€œdocker logs -f icinga2â€.</p>

<h2 id="wizualizacja-danych">Wizualizacja danych</h2>
<p>Kolejnym etapem jest skonfigurowanie Grafany, aby zaczÄ™Å‚a wyÅ›wietlaÄ‡ dane zbierane przez IcingÄ™. GrafanÄ™ znajdziemy na porcie 3000 na maszynie, na ktÃ³rej uruchomiono pobrany z GitHuba projekt. DomyÅ›lny login to admin, domyÅ›lne hasÅ‚o to takÅ¼e admin. Po zalogowaniu, podobnie jak w przypadku Icingi, konfigurujemy najpierw ÅºrÃ³dÅ‚o danych, jeÅ›li korzystamy z sieci Dockerâ€™a ÅºrÃ³dÅ‚o danych bÄ™dzie znajdowaÅ‚o siÄ™ na hoÅ›cie o nazwie influxdb, w przypadku korzystania z sieci hosta bÄ™dzie to localhost. NastÄ™pnie moÅ¼emy przejÅ›Ä‡ do konfiguracji Dashboardâ€™Ã³w czyli tablic agregujÄ…cych wykresy. Najpierw dodajemy wiersz, pÃ³Åºniej wykres, a nastÄ™pnie przechodzimy do edycji (konfiguracji) wykresu.</p>

<div class="img-with-legend">
<img src="/assets/img/posts/2017-12-01-monitoring-serwerow-i-uslug/2.png" />
<span class="img-legend">Konfiguracja wyÅ›wietlania metryk dla wykresu</span>
</div>

<p>Tak naprawdÄ™ wszystko tutaj powinno daÄ‡ siÄ™ wyklikaÄ‡, jeÅ›li brakuje jakiejÅ› metryki, a minÄ™Å‚o wiÄ™cej niÅ¼ 30-60 sekund od startu Icingi z nowÄ… konfiguracjÄ…, oznacza to bÅ‚Ä…d w konfiguracji. W takim przypadku istnieje szansa, Å¼e znajdziemy jakieÅ› informacje po wykonaniu komendy â€œdocker logs -f icinga2â€. W przypadku konfiguracji alertÃ³w istotne moÅ¼e okazaÄ‡ siÄ™ wypeÅ‚nienie miejsc, w ktÃ³rych brakuje danych. Na powyÅ¼szym screenie wybrano â€œnoneâ€ i takÄ… opcjÄ™ zalecaÅ‚bym na poczÄ…tek.</p>

<h2 id="powiadomienia-w-przypadku-problemu-z-usÅ‚ugami">Powiadomienia w przypadku problemu z usÅ‚ugami</h2>
<p>Kolejnym etapem bÄ™dzie konfiguracja powiadomieÅ„. Dla odmiany od najczÄ™Å›ciej wykorzystywanych powiadomieÅ„ mailowych w tym przypadku skorzystamy z komunikatora Slack.</p>

<ol>
  <li>Na poczÄ…tku musimy skonfigurowaÄ‡ SlackBota, a dokÅ‚adniej â€œIncoming Webhookâ€. W przypadku Consdaty moÅ¼na tego dokonaÄ‡ pod nastÄ™pujÄ…cym adresem: <a href="https://consdata.slack.com/apps/manage/custom-integrations">https://consdata.slack.com/apps/manage/custom-integrations</a></li>
  <li>Po otrzymaniu adresu URL naleÅ¼y go dodaÄ‡ w Menu â€œAlerting-&gt;Notification Channelsâ€. W razie potrzeb moÅ¼na swobodnie wykorzystaÄ‡ jeden URL, aby skonfigurowaÄ‡ kilka kanaÅ‚Ã³w:
    <div class="img-with-legend"><img src="/assets/img/posts/2017-12-01-monitoring-serwerow-i-uslug/3.png" /><span class="img-legend">Ekran edycji kanaÅ‚u powiadomieÅ„. W tym przypadku jako kanaÅ‚ dostarczania powiadomieÅ„ wybrano komunikator Slack</span></div>
  </li>
  <li>Po tym pozostaje juÅ¼ tylko konfiguracja powiadomieÅ„ dla kaÅ¼dego z wykresÃ³w z osobna
    <div class="img-with-legend"><img src="/assets/img/posts/2017-12-01-monitoring-serwerow-i-uslug/4.png" /><span class="img-legend">Konfiguracja wywoÅ‚ania powiadomienia na wykresie, dla ktÃ³rego wczeÅ›niej skonfigurowano zbieranie metryk</span></div>
    <div class="img-with-legend"><img src="/assets/img/posts/2017-12-01-monitoring-serwerow-i-uslug/5.png" /><span class="img-legend">Konfiguracja wywoÅ‚ania powiadomienia na wykresie - wybÃ³r sposobu wysyÅ‚ki alertu</span></div>
  </li>
  <li>Od tej chwili, w przypadku wystÄ…pienia problemÃ³w, moÅ¼emy spodziewaÄ‡ siÄ™ komunikatÃ³w podobnych do tego poniÅ¼ej
    <div class="img-with-legend"><img src="/assets/img/posts/2017-12-01-monitoring-serwerow-i-uslug/6.png" /><span class="img-legend">PrzykÅ‚adowy alert dostarczany na komunikator Slack</span></div>
  </li>
</ol>

<h2 id="podsumowanie">Podsumowanie</h2>
<p>PoÅ‚Ä…czenie Grafany, jako warstwy prezentacji i ostrzegania, oraz Icingi, jako narzÄ™dzia do zbierania metryk, jest dosyÄ‡ Å‚atwym i szybkim w zestawieniu systemem do monitorowania serwerÃ³w. Warto zwrÃ³ciÄ‡ uwagÄ™ takÅ¼e na wiele opcji budowania wÅ‚asnych tablic z wykresami. Poza grupowaniem wykresÃ³w w wiersze z opcjami zwijania, ustalania rÃ³Å¼nych rozmiarÃ³w czy umieszczania na tablicach kontrolek, ktÃ³re prezentujÄ… dane w innych formach niÅ¼ wykresy (np. w formie tabel lub pojedynczych wartoÅ›ci), wartÄ… uwagi jest funkcjonalnoÅ›Ä‡ zmiennych, ktÃ³rych moÅ¼na uÅ¼ywaÄ‡ na wykresach. Zmienne moÅ¼na definiowaÄ‡ za pomocÄ… wartoÅ›ci wpisanych na staÅ‚e, lub w formie zapytaÅ„. Jednym z zastosowaÅ„ takiej funkcjonalnoÅ›ci jest dynamiczna tablica zasilana metrykami z rÃ³Å¼nych serwerÃ³w w zaleÅ¼noÅ›ci od wybranej opcji.</p>

<div class="img-with-legend"><img src="/assets/img/posts/2017-12-01-monitoring-serwerow-i-uslug/7.png" /><span class="img-legend">Dashboard, na ktÃ³rym zaprezentowano przykÅ‚adowe uÅ¼ycie zmiennych. W tym wypadku jeden Dashboard jest w stanie przeÅ‚Ä…czaÄ‡ serwer, z ktÃ³rego wyÅ›wietlane sÄ… metryki</span></div>

<p>Niestety opcja ta nie jest pozbawiona wad i w bieÅ¼Ä…cej wersji Grafany (4.6.2), chcÄ…c skorzystaÄ‡ ze zmiennych, pozbawiamy siÄ™ moÅ¼liwoÅ›ci definiowania powiadomieÅ„.</p>

:ET