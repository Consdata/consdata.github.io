I"E)<p>W nawiÄ…zaniu do mojego poprzedniego wpisu pt.:<br />
<a href="/2020/02/01/keycloak-uwierzytelnianie-autoryzacja-springboot-angular.html"><strong>â€œKeycloak - uwierzytelnianie i autoryzacja uÅ¼ytkownika w aplikacji Angular/Spring Bootâ€</strong> ğŸ”—</a><br />
chciaÅ‚bym krÃ³tko opisaÄ‡ standard <a href="https://openid.net/connect/">OpenID Connect</a>, ktÃ³ry zostaÅ‚ wykorzystany podczas logowania do aplikacji przy uÅ¼yciu serwera uwierzytelniania <a href="https://www.keycloak.org/">Keycloak</a>.</p>

<h2 id="wstÄ™p">WstÄ™p</h2>

<p>Najpopularniejszymi standardami wykorzystywanymi do uwierzytelniania/autoryzacji sÄ… <code class="language-plaintext highlighter-rouge">OAuth 2.0</code>, <code class="language-plaintext highlighter-rouge">OpenID Connect</code> oraz <code class="language-plaintext highlighter-rouge">SAML</code>.<br />
O OAuth 2.0 zostaÅ‚o juÅ¼ napisanych wiele artykuÅ‚Ã³w, ktÃ³rych nie ma sensu powielaÄ‡. Jednak aby przedstawiÄ‡ OpenID Connect, musiaÅ‚bym opisaÄ‡ <a href="https://oauth.net/2/">OAuth 2.0</a> oraz <a href="https://jwt.io/">JWT</a>.</p>

<p>W celu zapoznania siÄ™ ze standardem OAuth 2.0 odeÅ›lÄ™ do artykuÅ‚u pt.:<br />
<a href="https://sekurak.pl/oauth-2-0-jak-dziala-jak-testowac-problemy-bezpieczenstwa/"><strong>â€œOAuth 2.0 â€“ jak dziaÅ‚a / jak testowaÄ‡ / problemy bezpieczeÅ„stwaâ€</strong> ğŸ”—</a><br />
autorstwa Marcina Pioska z portalu <a href="https://sekurak.pl/">Sekurak</a>, w ktÃ³rym zostaÅ‚a opisana terminologia, sposoby pozyskiwania tokenu oraz zasada dziaÅ‚ania standardu.</p>

<p>O JWT natomiast moÅ¼emy przeczytaÄ‡ w dokumencie <a href="https://tools.ietf.org/html/rfc7519">RFC7519</a>.</p>

<p>Dlaczego wiÄ™c do integracji naszej aplikacji z serwerem uwierzytelniania Keycloak uÅ¼yliÅ›my OpenID Connect?</p>

<h2 id="uwierzytelnianie-a-autoryzacja">Uwierzytelnianie a autoryzacja</h2>

<p>PoruszajÄ…c temat zabezpieczania zasobÃ³w i dostÄ™pu do nich, mÃ³wimy o takich pojÄ™ciach jak <strong>uwierzytelnianie</strong> (ang. authentication) oraz <strong>autoryzacja</strong> (ang. authorization).</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">uwierzytelnianie</code> to proces polegajÄ…cy na potwierdzeniu toÅ¼samoÅ›ci, czyli w skrÃ³cie - <em>kim jestem?</em>;</li>
  <li><code class="language-plaintext highlighter-rouge">autoryzacja</code> to proces nadawania uprawnieÅ„ (dostÄ™pu do zasobu), czyli w skrÃ³cie - <em>co mogÄ™ zrobiÄ‡?</em>.</li>
</ul>

<p>OAuth 2.0, wedÅ‚ug oficjalnej dokumentacji, nie powinien sÅ‚uÅ¼yÄ‡ do uwierzytelniania, a jedynie do autoryzacji (<a href="https://oauth.net/articles/authentication/">ÅºrÃ³dÅ‚o ğŸ”—</a>):</p>
<blockquote>
  <p>OAuth 2.0 is not an authentication protocol.</p>
</blockquote>

<p>JeÅ›li potrzebujemy mechanizmu pozwalajÄ…cego na poprawne zaimplementowanie uwierzytelniania, z pomocÄ… przychodzi OpenID Connect.</p>

<h2 id="openid-connect">OpenID Connect</h2>

<p>OpenID Connect jest prostÄ… warstwÄ… toÅ¼samoÅ›ci opartÄ… na OAuth 2.0.<br />
UmoÅ¼liwia klientom weryfikacjÄ™ toÅ¼samoÅ›ci uÅ¼ytkownika koÅ„cowego na podstawie uwierzytelnienia przeprowadzonego przez serwer autoryzacji, a takÅ¼e uzyskanie podstawowych informacji o jego profilu. Rozszerza OAuth 2.0, umoÅ¼liwiajÄ…c <strong>uwierzytelnianie stowarzyszone</strong> (ang. federated authentication):</p>

<ul>
  <li><strong>Federated Authentication</strong> - uÅ¼ytkownik loguje siÄ™ do serwisu Spotify przy uÅ¼yciu konta na portalu Facebook (<code class="language-plaintext highlighter-rouge">OpenID Connect</code>);</li>
  <li><strong>Delegated Authorization</strong> - Spotify prÃ³buje uzyskaÄ‡ dostÄ™p do listy znajomych na Facebooku, aby zaimportowaÄ‡ jÄ… do swojej bazy danych (<code class="language-plaintext highlighter-rouge">OAuth 2.0</code>).</li>
</ul>

<p>PrzepÅ‚yw procesu jest podobny do OAuth 2.0, ale dodatkowo w procesie bierze udziaÅ‚ <strong>ID Token</strong>.</p>

<h2 id="id-token">ID Token</h2>

<p>ID Token przypomina koncepcjÄ™ dowodu osobistego w formacie JWT, podpisanego przez dostawcÄ™ OpenID (OP). SpeÅ‚nia zaÅ‚oÅ¼enia standardu JWT, wiÄ™c skÅ‚ada siÄ™ z nagÅ‚Ã³wka, zawartoÅ›ci oraz
sygnatury. Jego zawartoÅ›Ä‡ moÅ¼e wiÄ™c wyglÄ…daÄ‡ nastÄ™pujÄ…co:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e78b5f41-e769-4353-8874-44302f4a17c3"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1583205992</span><span class="p">,</span><span class="w">
  </span><span class="nl">"nbf"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1583169992</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://localhost:8180/auth/realms/SpringBootAngular"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"developer"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c3c3755a-e499-4782-b119-a19bede0ace8"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"typ"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Serialized-ID"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"nonce"</span><span class="p">:</span><span class="w"> </span><span class="s2">"02c0b033-bfac-4030-a317-c18aec3cb2db"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"auth_time"</span><span class="p">:</span><span class="w"> </span><span class="mi">1583169991</span><span class="p">,</span><span class="w">
  </span><span class="nl">"acr"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"1"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"session_state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"8b66127b-4474-41bd-8e36-5d18286df73f"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"state_checker"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HZZmC4no-TEqiCf31Mk1MtONDqyxkk81ZXZCwANQb9Y"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jan Nowak"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"email"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jan.nowak@example.pl"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><strong>W skrÃ³cie, ID Token m.in.:</strong></p>

<ul>
  <li>potwierdza toÅ¼samoÅ›Ä‡ uÅ¼ytkownika, zwanego podmiotem w OpenID (<code class="language-plaintext highlighter-rouge">sub</code>);</li>
  <li>okreÅ›la organ wydajÄ…cy (<code class="language-plaintext highlighter-rouge">iss</code>);</li>
  <li>jest generowany dla okreÅ›lonej grupy odbiorcÃ³w - klienta (<code class="language-plaintext highlighter-rouge">aud</code>);</li>
  <li>moÅ¼e zawieraÄ‡ losowy ciÄ…g sÅ‚uÅ¼Ä…cy do identyfikowania pochodzenia Å¼Ä…dania (<code class="language-plaintext highlighter-rouge">nonce</code>);</li>
  <li>moÅ¼e okreÅ›laÄ‡ kiedy (<code class="language-plaintext highlighter-rouge">auth time</code>) i jak, pod wzglÄ™dem siÅ‚y (<code class="language-plaintext highlighter-rouge">acr</code>) uÅ¼ytkownik zostaÅ‚ uwierzytelniony;</li>
  <li>posiada znacznik czasu wydania (<code class="language-plaintext highlighter-rouge">iat</code>) oraz czas waÅ¼noÅ›ci (<code class="language-plaintext highlighter-rouge">exp</code>);</li>
  <li>moÅ¼e zawieraÄ‡ dodatkowe informacje takie jak imiÄ™, nazwisko (<code class="language-plaintext highlighter-rouge">name</code>) oraz adres email (<code class="language-plaintext highlighter-rouge">email</code>);</li>
  <li>jest podpisany cyfrowo, dziÄ™ki czemu moÅ¼e zostaÄ‡ zweryfikowany;</li>
  <li>opcjonalnie moÅ¼e zostaÄ‡ zaszyfrowany w celu zapewnienia poufnoÅ›ci danych.</li>
</ul>

<p>WiÄ™cej informacji na ten temat znajdziemy w <a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeIDToken">oficjalnej dokumentacji ğŸ”—</a>.</p>

<h2 id="podsumowanie">Podsumowanie</h2>

<p>DziÄ™ki wykorzystaniu <code class="language-plaintext highlighter-rouge">ID Token</code>, OpenID Connect nadaje siÄ™ do uwierzytelniania uÅ¼ytkownika, w przeciwieÅ„stwie do OAuth 2.0, ktÃ³ry najlepiej sprawdzi siÄ™ podczas autoryzacji dwÃ³ch aplikacji komunikujÄ…cych siÄ™ miÄ™dzy sobÄ… przez API.</p>

<p>Wiemy juÅ¼, Å¼e Federated Authentication ma zastosowanie, kiedy uÅ¼ytkownik loguje siÄ™ do serwisu przy uÅ¼yciu wspÃ³lnego konta.<br />
OpenID Connect wydaje siÄ™ wiÄ™c byÄ‡ naturalnym kandydatem do uwierzytelniania uÅ¼ytkownikÃ³w w rÃ³Å¼nego rodzaju serwisach spoÅ‚ecznoÅ›ciowych czy aplikacjach internetowych (<a href="/2020/02/01/keycloak-uwierzytelnianie-autoryzacja-springboot-angular.html">jak w przykÅ‚adzie logowania do aplikacji za poÅ›rednictwem Keycloaka</a>).</p>

<p>Delegated Authorization natomiast ma zastosowanie, kiedy klient (aplikacja) prÃ³buje uzyskaÄ‡ dostÄ™p do zasobÃ³w innej aplikacji. UÅ¼ytkownik musi jedynie zaakceptowaÄ‡ uprawnienia przyznawane aplikacji klienckiej, czyli np. odczyt listy znajomych na Facebooku, o ktÃ³ry ubiega siÄ™ Spotify.<br />
Tutaj do autoryzacji Spotify w Facebooku najlepiej spisze siÄ™ OAuth 2.0.</p>

<p><strong>Standardy wymienione we wstÄ™pie moÅ¼na podsumowaÄ‡ nastÄ™pujÄ…co:</strong></p>

<ul>
  <li><strong>OAuth 2.0</strong> - stworzony w 2006 roku przy wspÃ³Å‚pracy Twittera i Google, otwarty standard autoryzacji oparty o format JSON. GÅ‚Ã³wne zastosowanie to autoryzacja API miÄ™dzy dwoma aplikacjami;</li>
  <li><strong>OpenID Connect 1.0</strong> - stworzony w 2014 roku przez OpenID Foundation, otwarty standard uwierzytelniania oparty o format JSON. GÅ‚Ã³wne zastosowanie to SSO dla aplikacji konsumenckich;</li>
  <li><strong>SAML 2.0</strong> - stworzony w 2001 roku przez OASIS, otwarty standard autoryzacji i uwierzytelniania oparty o format XML. GÅ‚Ã³wne zastosowanie to SSO dla aplikacji enterprise.</li>
</ul>
:ET