I"R<p>Znajc definicj Event Sourcingu oraz korzyci, jakie nam zapewnia (dla przypomnienia polecam <a href="/2018/11/15/czy-apache-kafka-nadaje-sie-do-event-sourcingu.html"><strong>wpis Marcina powicony czciowo tej tematyce</strong></a>) warto rozwa偶y zastosowanie tego wzorca w swoim projekcie (oczywicie nie wszdzie si on nada).
Osoby zainteresowane tematem z pewnoci zostan postawione przed wyborem technologii, w kt贸rej rozpoczn implementacj. 
Niezale偶nie od jzyka programowania, mo偶na implementowa CQRS oraz Event Sourcing samemu, od A-Z, jednak偶e byoby to czasochonne i mo偶e prowadzi do wielu bd贸w. 
Alternatyw bdzie zatem skorzystanie z gotowego frameworku, kt贸ry od pocztku tworzony by z myl o wspomnianych wzorcach (wczajc w to mikroserwisy) - mowa tutaj o <a href="https://axoniq.io/"><strong>AxonFramework</strong></a>.</p>

<p>W tym wpisie przedstawi Axona i om贸wi wybory, przed kt贸rymi staem w kontekcie tego frameworka, oraz drog migracji z monolitu do mikroserwis贸w wraz z problemami, na kt贸re si natknem.</p>

<h1 id="kr贸tko-o-axonie">Kr贸tko o Axonie</h1>
<p>Axon to framework, kt贸ry czerpie garciami z Domain Driven Design (kt贸re jest poza zakresem tego wpisu), wykorzystujc r贸wnie偶 nomenklatur panujc w tym podejciu, kt贸r tak偶e bd si posugiwa w tym wpisie.
Axon bierze na barki zarzdzanie przepywem wszystkich informacji midzy komponentami np. kierowanie command贸w do odpowiednich agregat贸w, czy zapisywanie event贸w w event store. 
Je偶eli chodzi o kwestie event storea, to framework zostawia tu pen dowolno, cho nie ka偶da baza speni si w tej roli.
Dodatkowym plusem jest bezproblemowa integracja ze Spring Bootem, mo偶liwo skalowania i gotowo produkcyjna, co moim zdaniem czyni Axona mocnym graczem.</p>

<h1 id="event-store">Event store</h1>
<p>Fundamentem projektu opartego o Event Sourcing jest oczywicie event store - 藕r贸do prawdy caego systemu, std wyb贸r narzdzia pod t funkcj jest kluczowy.</p>

<h3 id="mo偶e-kafka">Mo偶e Kafka?</h3>
<p>Kafka opiera si na eventach, kt贸rych kolejno pojawiania si mo偶e zosta zachowana - co zapobiega sytuacji, w kt贸rej wykonamy aktualizacj krotki, zanim zostanie ona utworzona.
Ponadto Kafka trzyma dane na topicach, zapamitujc offset (liczb porzdkow) dla ka偶dego eventu. Znajc offset istnieje mo偶liwo odtworzenia topica od tego offsetu, a偶 do koca - umo偶liwia to odtwarzanie idealnego stanu aplikacji dosownie na zawoanie (dop贸ki nie mamy do czynienia z paruset milionami event贸w :wink:).
Do tego Kafka bardzo atwo si skaluje oraz uniemo偶liwia edycj nao偶onych event贸w, co niewtpliwie jest plusem. Jest jednak par punkt贸w, kt贸re brakuj Kafce, do bycia idealnym kandydatem na event store:</p>
<ul>
  <li>Problem pojawia si w momencie, gdy chcielibymy odtworzy agregat na podstawie event贸w. 
Kafka w tym momencie musiaaby przeiterowa cay topic od pewnego offsetu, a偶 do koca.
W kolejnym kroku konieczne jest odfiltrowanie event贸w nie zwizanych z agregatem, kt贸ry pr贸bujemy odtworzy, co wymaga od nas dodatkowej logiki w kodzie, oraz nakada niepotrzebny narzut na event store (odfiltrowane eventy nie s nam potrzebne).</li>
  <li>Drugim problemem jest brak natywnego wsparcia dla mechanizmu snapshot贸w, bez kt贸rego odtwarzanie stanu przy du偶ym wolumenie mo偶e trwa wieki.</li>
  <li>Kolejnym ograniczeniem r贸wnie wa偶nym co poprzednie, jest brak optimistic lockingu w Kafce (istnieje jedynie obejcie w postaci jednego wtku piszcego na topic). Bez tego mechanizmu, w wielowtkowej aplikacji mo偶e pojawi si problem, gdy wpadn dwa eventy w tym samym czasie - wtedy jedno z tych zdarze zaaplikuje si na modelu zbudowanym z niekompletnego zestawu event贸w.</li>
</ul>

<p>Potencjalnym rozwizaniem pierwszego problemu m贸gby by osobny topic dla ka偶dego agregatu, w贸wczas odpada konieczno filtrowania event贸w.
To rozwizanie jednak mo偶e nie sprawdzi si przy ogromnej iloci agregat贸w. 
Wynika to ze sposobu, w jaki Kafka przechowuje topici (a waciwie partycje) - dla ka偶dej tworzony jest osobny katalog w systemie plik贸w. 
Szczeg贸owe wyjanienie znajduje si w <a href="https://youtu.be/zUSWsJteRfw?t=2179"><strong>filmie</strong></a> przygotowanym przez AxonIQ (firma odpowiedzialna za rozw贸j Axona).</p>

<h3 id="axonserver">AxonServer</h3>
<p>W kwestii event store AxonIQ wyszed na przeciw potrzebom dajc do dyspozycji swoje narzdzie, kt贸re idealnie spenia si w tej roli - AxonServer:</p>
<ul>
  <li>Pozwala na dokadanie event贸w (z jednoczesnym brakiem mo偶liwoci edycji ju偶 istniejcych).</li>
  <li>Zapewnia sta wydajno niezale偶nie od iloci danych przetrzymywanych w event store.</li>
  <li>Umo偶liwia konstruowanie snapshot贸w dla agregat贸w i nakadanie ich (w przypadku du偶ej iloci event贸w rekonstrukcja agregatu bez funkcjonalnoci snapshot贸w mo偶e troch trwa).</li>
</ul>

<p>Po uruchomieniu AxonServera mamy dostp do dashboardu pokazujcego, kt贸ry mikroserwis jest podpity pod event store wraz z jego liczb instancji:
<img src="/assets/img/posts/2020-06-08-microservices-on-axon/axon_dashboard.png" alt="AxonDashboard" />
Na samym dashboardzie, funkcjonalnoci panelu administracyjnego si nie kocz:</p>
<ul>
  <li>Podgld konfiguracji wraz z przepustowoci (commandy/eventy/query/snapshoty na sekund).</li>
  <li>Mo偶liwo wyszukiwania eventu przy u偶yciu zapyta.</li>
  <li>Tabelka ze wskazaniem, kt贸ry command, ile razy i w jakim serwisie zosta obsu偶ony.</li>
  <li>Zarzdzanie dostpem do panelu.</li>
</ul>

<p>Oczywicie AxonFramework jest w peni kompatybilny z AxonServerem i dziaa out-of-the-box, bez dodatkowej konfiguracji.</p>

<h1 id="najpierw-monolit">Najpierw monolit</h1>
<p>Zaczynajc przygod z Axonem, nie chciaem skaka na gbok wod, zaczem wic od monolitu, majc jednak z tyu gowy perspektyw zmigrowania na co bardziej skalowalnego.
Migracja z monolitu na mikroserwisy nierzadko sprawia wiele problem贸w, tak byo r贸wnie偶 w moim przypadku z <a href="https://github.com/matty-matt/movie-keeper-core"><strong>t aplikacj</strong></a>.
W skr贸cie pozwala ona na wyszukiwanie film贸w po tytuach, wraz z ich obsad oraz trailerami korzystajc z <a href="https://developers.themoviedb.org/3/getting-started"><strong>API TMDb</strong></a>, zapisywanie wszystkiego w bazie, oznaczanie filmu jako przeczytany oraz sprawdzanie premiery cyfrowego wydania.
Stworzyem wic agregat filmu wraz z encjami zawierajcymi trailery oraz obsad:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aggregate</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieAggregate</span> <span class="o">{</span>
    <span class="nd">@AggregateIdentifier</span>
    <span class="kd">private</span> <span class="nc">MovieId</span> <span class="n">movieId</span><span class="o">;</span>
    <span class="nd">@AggregateMember</span>
    <span class="kd">private</span> <span class="nc">TrailerEntity</span> <span class="n">trailerEntity</span><span class="o">;</span>
    <span class="nd">@AggregateMember</span>
    <span class="kd">private</span> <span class="nc">CastEntity</span> <span class="n">castEntity</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Pobieranie danych z zewntrznego serwisu dziao si w event handlerze, poprzez zawoanie odpowiedniej metody z interfejsu ExternalService:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieEventsHandler</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@EventHandler</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">MovieSearchDelegatedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">...</span>
                <span class="nc">ExternalMovie</span> <span class="n">externalMovie</span> <span class="o">=</span> <span class="n">externalService</span><span class="o">.</span><span class="na">searchMovie</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getSearchPhrase</span><span class="o">());</span>
                <span class="n">commandGateway</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="k">new</span> <span class="nc">SaveMovieCommand</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getMovieId</span><span class="o">(),</span> <span class="n">externalMovie</span><span class="o">));</span>
            <span class="o">...</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Agregat obsugiwa SaveMovieCommand, wysyajc MovieSavedEvent, kt贸ry z kolei powoduje zapis do bazy:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@EventHandler</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">MovieSavedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">movieRepository</span><span class="o">.</span><span class="na">findByExternalMovieId</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getExternalMovie</span><span class="o">().</span><span class="na">getExternalMovieId</span><span class="o">().</span><span class="na">getId</span><span class="o">()).</span><span class="na">ifPresentOrElse</span><span class="o">(</span>
                <span class="n">movie</span> <span class="o">-&gt;</span> <span class="n">handleMovieDuplicate</span><span class="o">(),</span>
                <span class="o">()</span> <span class="o">-&gt;</span> <span class="n">persistMovie</span><span class="o">(</span><span class="n">event</span><span class="o">));</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>Szczeg贸owy diagram przepywu dla tego przypadku u偶ycia (ju偶 dla mikroserwis贸w) znajduje si w kolejnym rozdziale.</p>

<p>Projekt w tym momencie spenia moje wymagania i skada si z trzech element贸w:</p>
<ol>
  <li>Aplikacja-monolit</li>
  <li>Event store - AxonServer</li>
  <li>Storage, read model - MongoDB</li>
</ol>

<p>Uwidoczniy si poszczeg贸lne funkcjonalnoci, kt贸re mogyby by odrbnymi serwisami - mowa tu o zarzdzaniu: filmami, trailerami, obsad oraz serwis odpowiedzialny za odwie偶anie dat cyfrowej premiery wraz z ocenami i liczb gos贸w.</p>

<h1 id="mikroserwisy">Mikroserwisy</h1>
<p>Przysza pora na przekucie teorii w praktyk wykorzystujc wypracowany wczeniej podzia odpowiedzialnoci.
Aplikacja podzielona na mniejsze fragmenty (realizujce skoczone funkcjonalnoci) wygldaaby w ten spos贸b:</p>
<ul>
  <li>proxy-service, odpowiedzialny za pobieranie danych z zewntrznego serwisu.</li>
  <li>trailer-service, obsugujcy zapis/odczyt trailer贸w, serwujcy endpointy do pobierania trailer贸w.</li>
  <li>cast-service, robicy to samo dla obsady.</li>
  <li>movie-service, odpowiadajcy za szczeg贸y dot. filmu wraz z funkcjonalnoci cyfrowych premier, serwujcy wszystkie endpointy zwizane z filmem.</li>
</ul>

<p>Przejcie na mikroserwisy wizao si r贸wnie偶 ze stworzeniem API Gateway kierujcym ruch do odpowiedniego serwisu w zale偶noci od endpointu.</p>

<p>Na diagramie prezentuje si to nastpujco:
<img src="/assets/img/posts/2020-06-08-microservices-on-axon/diagram_komponentow.png" alt="Diagram komponent贸w" /></p>

<p>A tak prezentuje si przepyw Axonowych zdarze w przypadku wyszukania filmu z automatycznym zwr贸ceniem wyniku.
Obsada i trailery pobierane s z zewntrznego serwisu od razu i zapisywane do bazy. U偶ytkownik dopiero p贸藕niej mo偶e je pobra wchodzc w szczeg贸y wyszukanego filmu. 
<img src="/assets/img/posts/2020-06-08-microservices-on-axon/flowchart.png" alt="Diagram przepywu" /></p>

<h3 id="problemy">Problemy</h3>
<p>Migracja okazaa si bezbolesna dla Axon Servera, kt贸ry bez problemu zacz wykrywa nowe instancje. 
Pierwsze problemy zaczy pojawia si w momencie, gdy chciaem wysa command do innego mikroserwisu.
Z jakiego powodu aplikacja nie potrafia skorelowa commanda o tych samych polach i nazwie w jednym serwisie z identycznym commandem w drugim serwisie.
Okazao si, 偶e problem tkwi w serializacji - commandy byy w pakietach o innych nazwach, przez co nie byy interpretowane jako ten sam byt.
Nie chcc traci czasu, usp贸jniem pakiety midzy commandami i przepyw zacz dziaa.</p>

<h3 id="usprawnienia">Usprawnienia</h3>
<p>W midzyczasie zastpiem EventHandler odpowiadajcy za pobieranie danych z zewntrznego serwisu Sagami, kt贸re wysyaj commandy do proxy-service, aby wyszuka podany tytu.
Ten asynchronizm uodporni aplikacj na niedostpno zewntrznego serwisu lub dugi czas odpowiedzi:</p>
<ul>
  <li>movie-service
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Saga</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieSaga</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="nd">@StartSaga</span>
  <span class="nd">@SagaEventHandler</span><span class="o">(</span><span class="n">associationProperty</span> <span class="o">=</span> <span class="s">"movieId"</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">MovieSearchDelegatedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="n">commandGateway</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="k">new</span> <span class="nc">FetchMovieDetailsCommand</span><span class="o">(</span><span class="n">proxyId</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">getSearchPhrase</span><span class="o">()));</span>
  <span class="o">}</span>

  <span class="nd">@SagaEventHandler</span><span class="o">(</span><span class="n">associationProperty</span> <span class="o">=</span> <span class="s">"proxyId"</span><span class="o">)</span>
  <span class="nd">@EndSaga</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">MovieDetailsFetchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="kt">var</span> <span class="n">movie</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getExternalMovie</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="nc">MovieState</span><span class="o">.</span><span class="na">NOT_FOUND_IN_EXTERNAL_SERVICE</span> <span class="o">==</span> <span class="n">movie</span><span class="o">.</span><span class="na">getMovieState</span><span class="o">())</span> <span class="o">{</span>
          <span class="n">queryUpdateEmitter</span><span class="o">.</span><span class="na">emit</span><span class="o">(</span><span class="nc">GetMovieQuery</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">query</span> <span class="o">-&gt;</span> <span class="kc">true</span><span class="o">,</span> <span class="k">new</span> <span class="nc">MovieDTO</span><span class="o">(</span><span class="nc">MovieState</span><span class="o">.</span><span class="na">NOT_FOUND_IN_EXTERNAL_SERVICE</span><span class="o">));</span>
          <span class="n">end</span><span class="o">();</span>
      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
          <span class="n">commandGateway</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="k">new</span> <span class="nc">SaveMovieCommand</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">getExternalMovie</span><span class="o">()));</span>
      <span class="o">}</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>proxy-service
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProxyCommandHandler</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="nd">@CommandHandler</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">FetchMovieDetailsCommand</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ExternalMovie</span> <span class="n">externalMovie</span><span class="o">;</span>
      <span class="k">try</span> <span class="o">{</span>
          <span class="n">externalMovie</span> <span class="o">=</span> <span class="n">tmdbService</span><span class="o">.</span><span class="na">searchMovie</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getSearchPhrase</span><span class="o">());</span>
      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">NotFoundInExternalServiceException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">externalMovie</span> <span class="o">=</span> <span class="nc">ExternalMovie</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">movieState</span><span class="o">(</span><span class="nc">MovieState</span><span class="o">.</span><span class="na">NOT_FOUND_IN_EXTERNAL_SERVICE</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="n">eventGateway</span><span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="k">new</span> <span class="nc">MovieDetailsFetchedEvent</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getProxyId</span><span class="o">(),</span> <span class="n">externalMovie</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<p>Jako 偶e trailers i cast dostay sw贸j wasny serwis i nie byy ju偶 powizane z agregatem filmu, musiaem przekonwertowa je na samodzielne agregaty:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aggregate</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TrailerAggregate</span> <span class="o">{</span>
    <span class="nd">@AggregateIdentifier</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">trailersId</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Trailer</span><span class="o">&gt;</span> <span class="n">trailers</span><span class="o">;</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="podsumowanie">Podsumowanie</h1>
<p>Przejcie na architektur mikroserwis贸w niewtpliwie daje wiele korzyci, jednak bez wyklarowanego dobrego podziau jest to mocno utrudnione.
Axon sam w sobie sprzyja tej architekturze, a korzystajc z gotowych narzdzi, mo偶na tak migracj przeprowadzi w relatywnie kr贸tkim czasie.</p>

<p>Cay kod znajduje si w moim repozytorium <a href="https://github.com/matty-matt/movie-keeper-core"><strong>tutaj</strong></a>.</p>

<h1 id="藕r贸da">殴r贸da</h1>
<ul>
  <li><a href="https://github.com/matty-matt/movie-keeper-core">https://github.com/matty-matt/movie-keeper-core</a></li>
  <li><a href="https://axoniq.io/">https://axoniq.io/</a></li>
  <li><a href="https://youtu.be/zUSWsJteRfw?t=2179">https://youtu.be/zUSWsJteRfw?t=2179</a></li>
</ul>
:ET