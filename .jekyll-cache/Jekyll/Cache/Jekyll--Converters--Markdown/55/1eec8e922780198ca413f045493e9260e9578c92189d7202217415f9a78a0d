I"ÀO<p>KsiÄ…Å¼ka â€œRefactoringâ€ Martina Fowlera i Kenta Becka zostaÅ‚a po raz pierwszy wydana w 1999 roku i czÄ™sto okreÅ›lana jest jako pozycja wybitna, ponadczasowa, jako must read kaÅ¼dego programisty. 
Dodatkowo w tym roku wyszÅ‚a jej druga edycja. Po co?</p>

<p>Martin podkreÅ›la przecieÅ¼, Å¼e notatki z lat dziewiÄ™Ä‡dziesiÄ…tych, ktÃ³re tworzyÅ‚ i ogÃ³lnie zasady refaktoryzacji wciÄ…Å¼ sÄ… aktualne i wciÄ…Å¼ sam ich uÅ¼ywa. Mimo to wszystkie jej rozdziaÅ‚y zostaÅ‚y przepisane, a przede wszystkim zmieniÅ‚ siÄ™ jÄ™zyk wykorzystany w przykÅ‚adach - wtedy wybrali JavÄ™, tym razem postawili na JavaScript.</p>

<p>DominujÄ…ca czÄ™Å›Ä‡ tej pozycji to katalog reguÅ‚ refaktoryzacji wraz z motywacjÄ…, sposobem jej wykonania i oczywiÅ›cie kodem. 
Zanim jednak tam dotrzemy, Fowler prÃ³buje wytÅ‚umaczyÄ‡, po co w ogÃ³le refaktoryzowaÄ‡ i kiedy to robiÄ‡.
I to, co najbardziej wyniosÅ‚am z tej lektury to podejÅ›cie, ktÃ³re przewija siÄ™ w niej bardzo czÄ™sto: mianowicie, Å¼e refaktoryzacja powinna byÄ‡ â€œczÄ™Å›ciÄ… naturalnego flow programistyâ€.</p>

<p>Gdy podchodzimy do zadania, chcemy dodaÄ‡ nowÄ… funkcjonalnoÅ›Ä‡, powinniÅ›my mÃ³c jÄ… wprowadziÄ‡ w zastany kod w sposÃ³b Å‚atwy i Å‚adny. JeÅ›li jednak jego stan nam na to nie pozwala, moÅ¼e powinniÅ›my pokusiÄ‡ siÄ™ o jego reorganizacjÄ™, tak Å¼ebyÅ›my mogli pÃ³Åºniej szybko i bez wyrzutÃ³w sumienia wprowadzaÄ‡ zmiany. Bardzo trafnie opisuje to cytat:</p>

<blockquote>"It's like I want to go 100 miles east but instead of just traipsing through the woods, I'm going to drive 20 miles north to the highway and then I'm going to go 100 miles east at three times the speed I could have if I just went straight there. When people are pushing you to just go straight there, sometimes you need to say 'Wait, I need to check the map and find the quickest route'."</blockquote>
<p>Zanim przejdziemy do przykÅ‚adÃ³w, jeszcze jedna motywacja, czyli to, jak okreÅ›la sam siebie Kent Beck:</p>

<blockquote>"I'm not a great programmer. I'm just a good programmer with great habits."</blockquote>

<h2 id="przykÅ‚ad-pierwszy">PrzykÅ‚ad pierwszy</h2>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">solveIdealRocketEquation</span><span class="p">(</span><span class="nx">specificImpulse</span><span class="p">,</span> <span class="nx">initialMass</span><span class="p">,</span> <span class="nx">finalMass</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">exhaustVelocity</span> <span class="o">=</span> <span class="nx">specificImpulse</span> <span class="o">*</span> <span class="mf">9.81</span><span class="p">;</span>
	<span class="kd">const</span> <span class="nx">massFraction</span> <span class="o">=</span> <span class="nx">initialMass</span><span class="o">/</span><span class="nx">finalMass</span><span class="p">;</span>
	<span class="k">return</span> <span class="nx">exhaustVelocity</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">massFraction</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Refaktor powyÅ¼szego przykÅ‚adu rozpoczniemy od zastosowania wyodrÄ™bnienia metod (Extract Function).</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">solveIdealRocketEquation</span><span class="p">(</span><span class="nx">specificImpulse</span><span class="p">,</span> <span class="nx">initialMass</span><span class="p">,</span> <span class="nx">finalMass</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">exhaustVelocity</span> <span class="o">=</span> <span class="nx">specificImpulse</span> <span class="o">*</span> <span class="mf">9.81</span><span class="p">;</span>
	<span class="kd">const</span> <span class="nx">massFraction</span> <span class="o">=</span> <span class="nx">initialMass</span><span class="o">/</span><span class="nx">finalMass</span><span class="p">;</span>
	<span class="k">return</span> <span class="nx">calculateVelocity</span><span class="p">(</span><span class="nx">exhaustVelocity</span><span class="p">,</span> <span class="nx">massFraction</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">calculateVelocity</span><span class="p">(</span><span class="nx">exhaustVelocity</span><span class="p">,</span> <span class="nx">massFraction</span><span class="p">){</span>
	<span class="k">return</span> <span class="nx">exhaustVelocity</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">massFraction</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>NastÄ™pnie wprowadzimy strukturÄ™ sÅ‚uÅ¼Ä…cÄ… do komunikacji (Introduce Parameter Object).</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">solveIdealRocketEquation</span><span class="p">(</span><span class="nx">specificImpulse</span><span class="p">,</span> <span class="nx">initialMass</span><span class="p">,</span> <span class="nx">finalMass</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">exhaustVelocity</span> <span class="o">=</span> <span class="nx">specificImpulse</span> <span class="o">*</span> <span class="mf">9.81</span><span class="p">;</span>
	<span class="kd">const</span> <span class="nx">massFraction</span> <span class="o">=</span> <span class="nx">initialMass</span><span class="o">/</span><span class="nx">finalMass</span><span class="p">;</span>
	<span class="kd">const</span> <span class="nx">velocityData</span> <span class="o">=</span> <span class="p">{</span><span class="na">exhaustVelocity</span><span class="p">:</span> <span class="nx">exhaustVelocity</span><span class="p">,</span> <span class="na">massFraction</span><span class="p">:</span> <span class="nx">massFraction</span><span class="p">}</span>
	<span class="k">return</span> <span class="nx">calculateVelocity</span><span class="p">(</span><span class="nx">velocityData</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">calculateVelocity</span><span class="p">(</span><span class="nx">velocityData</span><span class="p">){</span>
	<span class="k">return</span> <span class="nx">velocityData</span><span class="p">.</span><span class="nx">exhaustVelocity</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">velocityData</span><span class="p">.</span><span class="nx">massFraction</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I z tak posprzÄ…tanymi parametrami, moÅ¼emy wydzieliÄ‡ dwie, niezaleÅ¼ne fazy naszych obliczeÅ„ (Split Phase).</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">solveIdealRocketEquation</span><span class="p">(</span><span class="nx">specificImpulse</span><span class="p">,</span> <span class="nx">initialMass</span><span class="p">,</span> <span class="nx">finalMass</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="nx">velocityData</span> <span class="o">=</span> <span class="nx">calculateVelocityData</span><span class="p">(</span><span class="nx">specificImpulse</span><span class="p">,</span> <span class="nx">initialMass</span><span class="p">,</span> <span class="nx">finalMass</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">calculateVelocity</span><span class="p">(</span><span class="nx">velocityData</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">calculateVelocity</span><span class="p">(</span><span class="nx">velocityData</span><span class="p">){</span>
	<span class="k">return</span> <span class="nx">velocityData</span><span class="p">.</span><span class="nx">exhaustVelocity</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">velocityData</span><span class="p">.</span><span class="nx">massFraction</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">calculateVelocityData</span><span class="p">(</span><span class="nx">specificImpulse</span><span class="p">,</span> <span class="nx">initialMass</span><span class="p">,</span> <span class="nx">finalMass</span><span class="p">){</span>
	<span class="kd">const</span> <span class="nx">exhaustVelocity</span> <span class="o">=</span> <span class="nx">specificImpulse</span> <span class="o">*</span> <span class="mf">9.81</span><span class="p">;</span>
	<span class="kd">const</span> <span class="nx">massFraction</span> <span class="o">=</span> <span class="nx">initialMass</span><span class="o">/</span><span class="nx">finalMass</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">{</span><span class="na">exhaustVelocity</span><span class="p">:</span> <span class="nx">exhaustVelocity</span><span class="p">,</span> <span class="na">massFraction</span><span class="p">:</span> <span class="nx">massFraction</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="przykÅ‚ad-drugi">PrzykÅ‚ad drugi</h2>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">aggregateStarsData</span><span class="p">(</span><span class="nx">stars</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nx">highestTemperature</span> <span class="o">=</span> <span class="nx">stars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">?</span> <span class="nx">stars</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">temperature</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">totalMass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">s</span> <span class="k">of</span> <span class="nx">stars</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">temperature</span> <span class="o">&gt;</span> <span class="nx">highestTemperature</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">highestTemperature</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">temperature</span>
	    <span class="p">}</span>
	<span class="nx">totalMass</span> <span class="o">+=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mass</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="na">highestTemperature</span><span class="p">:</span> <span class="nx">highestTemperature</span><span class="p">,</span> <span class="na">totalMass</span><span class="p">:</span> <span class="nx">totalMass</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>W powyÅ¼szym przykÅ‚adzie obliczamy Å‚Ä…cznÄ… masÄ™ gwiazd oraz znajdujemy gwiazdÄ™, ktÃ³rej temperatura jest najwyÅ¼sza. Wyliczenia te przetwarzane sÄ… w tej samej pÄ™tli, chociaÅ¼ sÄ… od siebie niezaleÅ¼ne. Minusem tego podejÅ›cia jest to, Å¼e za kaÅ¼dym razem, gdy bÄ™dziemy chcieli takÄ… pÄ™tlÄ™ zmodyfikowaÄ‡, bÄ™dziemy musieli zrozumieÄ‡ obie te rzeczy. Podzielmy jÄ… wiÄ™c na dwie, tak abyÅ›my mogli prÃ³bowaÄ‡ zrozumieÄ‡ tylko tÄ™ czÄ™Å›Ä‡, ktÃ³rÄ… musimy zmodyfikowaÄ‡ (Split Loop).</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">aggregateStarsData</span><span class="p">(</span><span class="nx">stars</span><span class="p">){</span>
    <span class="kd">let</span> <span class="nx">highestTemperature</span> <span class="o">=</span> <span class="nx">stars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">?</span> <span class="nx">stars</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">temperature</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">s</span> <span class="k">of</span> <span class="nx">stars</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">temperature</span> <span class="o">&gt;</span> <span class="nx">highestTemperature</span><span class="p">)</span> <span class="p">{</span>
		    <span class="nx">highestTemperature</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">temperature</span>
	    <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">let</span> <span class="nx">totalMass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">s</span> <span class="k">of</span> <span class="nx">stars</span><span class="p">)</span> <span class="p">{</span>
	        <span class="nx">totalMass</span> <span class="o">+=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mass</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="na">highestTemperature</span><span class="p">:</span> <span class="nx">highestTemperature</span><span class="p">,</span> <span class="na">totalMass</span><span class="p">:</span> <span class="nx">totalMass</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>NastÄ™pnie powydzielajmy metody (Extract Function).</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">aggregateStarsData</span><span class="p">(</span><span class="nx">stars</span><span class="p">){</span>
	<span class="k">return</span> <span class="p">{</span><span class="na">highestTemperature</span><span class="p">:</span> <span class="nx">highestTemperature</span><span class="p">(</span><span class="nx">stars</span><span class="p">),</span> <span class="na">totalMass</span><span class="p">:</span> <span class="nx">totalMass</span><span class="p">(</span><span class="nx">stars</span><span class="p">)}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">highestTemperature</span><span class="p">(</span><span class="nx">stars</span><span class="p">){</span>
	<span class="kd">let</span> <span class="nx">highestTemperature</span> <span class="o">=</span> <span class="nx">stars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">?</span> <span class="nx">stars</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">temperature</span> <span class="p">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">s</span> <span class="k">of</span> <span class="nx">stars</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">temperature</span> <span class="o">&gt;</span> <span class="nx">highestTemperature</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">highestTemperature</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">temperature</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">highestTemperature</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">totalMass</span><span class="p">(</span><span class="nx">stars</span><span class="p">){</span>
	<span class="kd">let</span> <span class="nx">totalMass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="kd">const</span> <span class="nx">s</span> <span class="k">of</span> <span class="nx">stars</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">totalMass</span> <span class="o">+=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mass</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">totalMass</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>
<p>I uÅ¼yjmy jeszcze dwÃ³ch metod refaktoryzacji: Replace Loop with Pipeline oraz Subsitute Algorithm.</p>
<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">aggregateStarsData</span><span class="p">(</span><span class="nx">stars</span><span class="p">){</span>
	<span class="k">return</span> <span class="p">{</span><span class="na">highestTemperature</span><span class="p">:</span> <span class="nx">highestTemperature</span><span class="p">(</span><span class="nx">stars</span><span class="p">),</span> <span class="na">totalMass</span><span class="p">:</span> <span class="nx">totalMass</span><span class="p">(</span><span class="nx">stars</span><span class="p">)}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">highestTemperature</span><span class="p">(</span><span class="nx">stars</span><span class="p">){</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(...</span><span class="nx">stars</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">s</span><span class="o">=&gt;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">temperature</span><span class="p">))</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">totalMass</span><span class="p">(</span><span class="nx">stars</span><span class="p">){</span>
    <span class="k">return</span> <span class="nx">stars</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">totalMass</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">totalMass</span> <span class="o">+=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">mass</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="podsumowanie">Podsumowanie</h2>

<p>â€œRefactoringâ€ Fowlera i Becka to ksiÄ…Å¼ka, ktÃ³rÄ… na pewno doceniÄ… osoby, ktÃ³re pracujÄ… przy duÅ¼ych i dÅ‚ugofalowych projektach. Wtedy bowiem potrzeba refaktorowania jest bezdyskusyjna, jednak jest on czasochÅ‚onny i ryzykowny. Åatwo wpaÅ›Ä‡ w puÅ‚apkÄ™, w ktÃ³rej zmiany, ktÃ³re dodajemy, wprowadzajÄ… baÅ‚agan do kodu i tÅ‚umaczone sÄ… poÅ›piechem. Jednak czas, ktÃ³ry zaoszczÄ™dzimy przy jej dodawaniu, zostanie zjedzony w caÅ‚oÅ›ci, a pewnie i przekroczony, gdy kolejna osoba bÄ™dzie musiaÅ‚a wejÅ›Ä‡ w nasze klasy i zrozumieÄ‡, jak to wÅ‚aÅ›ciwie dziaÅ‚a.</p>

<p>PodejdÅºmy wiÄ™c do problemu zdrowo i po prostu - zawsze zostawiajmy kod choÄ‡ odrobinÄ™ lepszym, niÅ¼ ten ktÃ³ry zastaliÅ›my;)</p>
:ET