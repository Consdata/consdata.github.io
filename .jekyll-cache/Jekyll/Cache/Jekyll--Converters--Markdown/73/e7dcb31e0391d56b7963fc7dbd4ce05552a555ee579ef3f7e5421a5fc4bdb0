I"»±<p>Powszechnie wiadomo, Å¼e kod dobrze pokryty testami jest duÅ¼o bardziej podatny na rozwÃ³j - wszak nie musimy obawiaÄ‡ siÄ™, Å¼e nasza zmiana spowoduje np. powrÃ³t znanego wczeÅ›niej bÅ‚Ä™du.
<a href="/2020/06/09/microservices-on-axon.html">W poprzednim wpisie</a> opisaÅ‚em swoje zmagania z migracjÄ… monolitu do mikroserwisÃ³w na Axonie, umyÅ›lnie pomijajÄ…c kwestiÄ™ zwiÄ…zanÄ… z testami.
Niniejszy artykuÅ‚ jest poÅ›wiÄ™cony w peÅ‚ni temu tematowi.
PrzedstawiÄ™ w nim kilka elementÃ³w skÅ‚adajÄ…cych siÄ™ na kompleksowo przetestowanÄ… aplikacjÄ™ opartÄ… o Axona.</p>

<h1 id="testy-domenowe">Testy domenowe</h1>
<p>Zacznijmy od przetestowania domeny, czyli logiki biznesowej zawartej w obiektach domenowych.
W Axonie jest to uÅ‚atwione, poprzez gotowe narzÄ™dzia, ktÃ³re dostajemy w pakiecie z frameworkiem.
Zaleta tych testÃ³w jest taka, Å¼e nie podnoszÄ… one Å¼adnego kontekstu, a wiÄ™c wykonujÄ… siÄ™ bardzo szybko.</p>

<h2 id="agregaty">Agregaty</h2>
<p>ZostajÄ…c przy aplikacji z poprzedniego wpisu, weÅºmy jako przykÅ‚ad oznaczanie filmu jako obejrzany/nieobejrzany.
Niezmiennik agregatu mÃ³wi, Å¼e gdy film jest juÅ¼ oznaczony jako obejrzany, to nie moÅ¼emy tego zrobiÄ‡ ponownie - tak samo nieobejrzanego filmu nie moÅ¼emy â€œodzobaczyÄ‡â€ ;).
WystÄ…pienie takiej anomalii odnotowywane jest w logu, a <strong>ToggleWatchedEvent</strong> nie zostaje wyemitowany.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Aggregate</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieAggregate</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@CommandHandler</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">ToggleWatchedCommand</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">watched</span><span class="o">.</span><span class="na">isWatched</span><span class="o">()</span> <span class="o">==</span> <span class="n">command</span><span class="o">.</span><span class="na">getWatched</span><span class="o">().</span><span class="na">isWatched</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Cannot toggle to the same state, skipping.."</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">apply</span><span class="o">(</span><span class="k">new</span> <span class="nc">ToggleWatchedEvent</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getMovieId</span><span class="o">(),</span> <span class="n">command</span><span class="o">.</span><span class="na">getWatched</span><span class="o">()));</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>RozwaÅ¼my tzw. happy path w testach dla tego przypadku biznesowego. 
BÄ™dziemy potrzebowaÄ‡ obiektu <strong>FixtureConfiguration</strong>, ktÃ³ry zasymuluje nam sytuacjÄ™, w ktÃ³rej moÅ¼e znaleÅºÄ‡ siÄ™ nasz agregat.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieAggregateTest</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">private</span> <span class="nc">FixtureConfiguration</span><span class="o">&lt;</span><span class="nc">MovieAggregate</span><span class="o">&gt;</span> <span class="n">fixture</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">fixture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">AggregateTestFixture</span><span class="o">&lt;&gt;(</span><span class="nc">MovieAggregate</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Test piszemy w nastÄ™pujÄ…cy sposÃ³b:</p>
<ol>
  <li>OkreÅ›lamy â€œpunkt startowyâ€ dla naszego agregatu, czyli jakie eventy zostaÅ‚y zastosowane w agregacie do tej pory (jest to <strong>given</strong> w podejÅ›ciu behawioralnym).</li>
  <li>Wpisujemy command, ktÃ³ry chcemy poddaÄ‡ testom (odpowiednio - <strong>when</strong>). W naszym przypadku to <strong>ToggleWatchedCommand</strong></li>
  <li>Definiujemy stan oczekiwany.</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieAggregateTest</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldToggleWatchedEventAppear</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">fixture</span><span class="o">.</span><span class="na">given</span><span class="o">(</span>                                                              <span class="c1">// 1</span>
                    <span class="k">new</span> <span class="nf">MovieCreatedEvent</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="n">searchPhrase</span><span class="o">),</span>
                    <span class="k">new</span> <span class="nf">MovieSavedEvent</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="n">externalMovie</span><span class="o">))</span>
                <span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="k">new</span> <span class="nc">ToggleWatchedCommand</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Watched</span><span class="o">(</span><span class="kc">true</span><span class="o">)))</span>         <span class="c1">// 2</span>
                <span class="o">.</span><span class="na">expectEvents</span><span class="o">(</span><span class="k">new</span> <span class="nc">ToggleWatchedEvent</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Watched</span><span class="o">(</span><span class="kc">true</span><span class="o">)))</span>   <span class="c1">// 3</span>
                <span class="o">.</span><span class="na">expectState</span><span class="o">(</span>                                                       
                    <span class="n">state</span> <span class="o">-&gt;</span> <span class="n">assertThat</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">getWatched</span><span class="o">().</span><span class="na">isWatched</span><span class="o">()).</span><span class="na">isTrue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Druga Å›cieÅ¼ka do sprawdzenia to brak emisji zdarzenia w momencie zmiany stanu na ten sam.
DorzuÄ‡my wiÄ™c do <strong>given</strong> wystÄ…pienie eventu <strong>ToggleWatchedEvent</strong> - wtedy agregat nie powinien wyemitowaÄ‡ nic nowego:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieAggregateTest</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldNotToggleWatchedEventAppear</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">fixture</span><span class="o">.</span><span class="na">given</span><span class="o">(</span>
                    <span class="k">new</span> <span class="nf">MovieCreatedEvent</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="n">searchPhrase</span><span class="o">),</span>
                    <span class="k">new</span> <span class="nf">MovieSavedEvent</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="n">externalMovie</span><span class="o">),</span>
                    <span class="k">new</span> <span class="nf">ToggleWatchedEvent</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Watched</span><span class="o">(</span><span class="kc">true</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">when</span><span class="o">(</span><span class="k">new</span> <span class="nc">ToggleWatchedCommand</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="k">new</span> <span class="nc">Watched</span><span class="o">(</span><span class="kc">true</span><span class="o">)))</span>
                <span class="o">.</span><span class="na">expectNoEvents</span><span class="o">()</span>
                <span class="o">.</span><span class="na">expectState</span><span class="o">(</span>                                                       
                    <span class="n">state</span> <span class="o">-&gt;</span> <span class="n">assertThat</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="na">getWatched</span><span class="o">().</span><span class="na">isWatched</span><span class="o">()).</span><span class="na">isTrue</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<h2 id="sagi">Sagi</h2>
<p>Drugim obiektem domenowym, ktÃ³ry poddam testom, jest saga (zob. DDD).
W mojej aplikacji zdarzeniem otwierajÄ…cym sagÄ™ dla filmu jest <strong>MovieCreatedEvent</strong> wyemitowany przez MovieAggrate - po jego pojawieniu siÄ™, wysyÅ‚am command, ktÃ³ry zostanie obsÅ‚uÅ¼ony w mikroserwisie (<em>proxy-service</em>) odpowiedzialnym za pobieranie szczegÃ³Å‚Ã³w filmu z zewnÄ™trznego ÅºrÃ³dÅ‚a:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieSaga</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@StartSaga</span>
    <span class="nd">@SagaEventHandler</span><span class="o">(</span><span class="n">associationProperty</span> <span class="o">=</span> <span class="no">MOVIE_ID</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">MovieCreatedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">movieId</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getMovieId</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">proxyId</span> <span class="o">=</span> <span class="no">PROXY_PREFIX</span><span class="o">.</span><span class="na">concat</span><span class="o">(</span><span class="n">movieId</span><span class="o">);</span>
        <span class="n">associateWith</span><span class="o">(</span><span class="s">"proxyId"</span><span class="o">,</span> <span class="n">proxyId</span><span class="o">);</span>
        <span class="n">commandGateway</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="k">new</span> <span class="nc">FetchMovieDetailsCommand</span><span class="o">(</span><span class="n">proxyId</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">getSearchPhrase</span><span class="o">()));</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Proces ten moÅ¼e trochÄ™ potrwaÄ‡ (niedostÄ™pnoÅ›Ä‡ zewnÄ™trznego ÅºrÃ³dÅ‚a, timeouty, problemy z Å‚Ä…czem), dlatego teÅ¼ zdecydowaÅ‚em siÄ™ na sagÄ™, ktÃ³ra jest rozwiÄ…zaniem nieblokujÄ…cym.
Gdy <em>proxy-service</em> wyemituje zdarzenie <strong>MovieDetailsEvent</strong>, to w zaleÅ¼noÅ›ci od zawartoÅ›ci payloadu, Å›le command z uzupeÅ‚nionymi szczegÃ³Å‚ami dla filmu lub nie i bez wzglÄ™du na rezultat koÅ„czÄ™ sagÄ™:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieSaga</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@SagaEventHandler</span><span class="o">(</span><span class="n">associationProperty</span> <span class="o">=</span> <span class="no">PROXY_ID</span><span class="o">)</span>
    <span class="nd">@EndSaga</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">MovieDetailsEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">var</span> <span class="n">movie</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getExternalMovie</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="nc">MovieState</span><span class="o">.</span><span class="na">NOT_FOUND_IN_EXTERNAL_SERVICE</span> <span class="o">==</span> <span class="n">movie</span><span class="o">.</span><span class="na">getMovieState</span><span class="o">())</span> <span class="o">{</span>
            <span class="c1">// handle when movie not found</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">commandGateway</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="k">new</span> <span class="nc">SaveMovieCommand</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="n">event</span><span class="o">.</span><span class="na">getExternalMovie</span><span class="o">()));</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Do przetestowania tego przypadku znÃ³w bÄ™dziemy potrzebowaÄ‡ <strong>fixture</strong>, tyle Å¼e tym razem skrojony pod sagi:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieSagaTest</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">private</span> <span class="nc">SagaTestFixture</span><span class="o">&lt;</span><span class="nc">MovieSaga</span><span class="o">&gt;</span> <span class="n">fixture</span><span class="o">;</span>

    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">fixture</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SagaTestFixture</span><span class="o">&lt;&gt;(</span><span class="nc">MovieSaga</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="o">...</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Testy majÄ… sprawdziÄ‡ czy odpowiednie commandy zostanÄ… wyemitowane, oraz czy saga â€œwystartowaÅ‚aâ€, bÄ…dÅº zakoÅ„czyÅ‚a siÄ™ w odpowiednim momencie.
Szkielet testu wyglÄ…da nastÄ™pujÄ…co:</p>
<ol>
  <li>MajÄ…c agregat X z ustalonym identyfikatorem.</li>
  <li>WiedzÄ…c, Å¼e X nie wyemitowaÅ‚ Å¼adnego eventu (lub wyemitowaÅ‚ konkretny event).</li>
  <li>To gdy agregat X.</li>
  <li>Wyemituje konkretny event.</li>
  <li>Oczekujemy aktywnej (lub nieaktywnej) sagi oraz opublikowany command (lub nieopublikowanie niczego).</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieSagaTest</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldDispatchFetchMovieDetailsCommand</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">fixture</span><span class="o">.</span><span class="na">givenAggregate</span><span class="o">(</span><span class="n">movieId</span><span class="o">)</span>                                      <span class="c1">// 1</span>
                <span class="o">.</span><span class="na">published</span><span class="o">()</span>                                                 <span class="c1">// 2</span>
                <span class="o">.</span><span class="na">whenAggregate</span><span class="o">(</span><span class="n">movieId</span><span class="o">)</span>                                      <span class="c1">// 3</span>
                <span class="o">.</span><span class="na">publishes</span><span class="o">(</span><span class="k">new</span> <span class="nc">MovieCreatedEvent</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="n">searchPhrase</span><span class="o">))</span>     <span class="c1">// 4</span>
                <span class="o">.</span><span class="na">expectActiveSagas</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span>                                        <span class="c1">// 5</span>
                <span class="o">.</span><span class="na">expectDispatchedCommands</span><span class="o">(</span>                                   
                    <span class="k">new</span> <span class="nf">FetchMovieDetailsCommand</span><span class="o">(</span><span class="n">proxyId</span><span class="o">,</span> <span class="n">searchPhrase</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldDispatchSaveCastCommand</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">fixture</span><span class="o">.</span><span class="na">givenAggregate</span><span class="o">(</span><span class="n">movieId</span><span class="o">)</span>                                       <span class="c1">// 1</span>
                <span class="o">.</span><span class="na">published</span><span class="o">(</span><span class="k">new</span> <span class="nc">MovieCreatedEvent</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="n">searchPhrase</span><span class="o">))</span>      <span class="c1">// 2</span>
                <span class="o">.</span><span class="na">whenAggregate</span><span class="o">(</span><span class="n">proxyId</span><span class="o">)</span>                                       <span class="c1">// 3</span>
                <span class="o">.</span><span class="na">publishes</span><span class="o">(</span><span class="k">new</span> <span class="nc">MovieDetailsEvent</span><span class="o">(</span><span class="n">proxyId</span><span class="o">,</span> <span class="n">externalMovie</span><span class="o">))</span>     <span class="c1">// 4</span>
                <span class="o">.</span><span class="na">expectActiveSagas</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>                                         <span class="c1">// 5</span>
                <span class="o">.</span><span class="na">expectDispatchedCommands</span><span class="o">(</span>                                    
                    <span class="k">new</span> <span class="nf">SaveMovieCommand</span><span class="o">(</span><span class="n">movieId</span><span class="o">,</span> <span class="n">externalMovie</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Jak widaÄ‡ zastosowanie fixture rÃ³wnieÅ¼ w przypadku sagi, okazuje siÄ™ proste i intuicyjne.</p>

<h1 id="testy-integracyjne---moÅ¼liwe-z-axonem">Testy integracyjne - moÅ¼liwe z Axonem?</h1>
<p>Po testach domenowych, gdy wiemy juÅ¼, Å¼e nasza logika biznesowa jest poprawna (i mamy na to dowody w postaci testÃ³w!), moÅ¼na zabraÄ‡ siÄ™ za weryfikacjÄ™ trochÄ™ wiÄ™kszego fragmentu aplikacji.</p>

<h2 id="konfiguracja">Konfiguracja</h2>
<p>Testy integracyjne z uÅ¼yciem prawdziwego Event Storeâ€™a (w naszym przypadku AxonServera) wymagajÄ… wiÄ™cej konfiguracji - twÃ³rcy w tym aspekcie akurat nie przygotowali nam gotowego rozwiÄ…zania.
TrochÄ™ siÄ™ naszukaÅ‚em, zanim znalazÅ‚em informacjÄ™ o tym, Å¼e rekomendowanym przez AxonIQ rozwiÄ…zaniem problemu jest skorzystanie z obrazu dockerowego.
Konkretnie wspominajÄ… o uruchomieniu AxonServer z terminala i podÅ‚Ä…czeniu siÄ™ testami do tej instancji.
WrÄ™cz idealna rola dla <a href="https://www.testcontainers.org/"><strong>testcontainers</strong></a> - pomyÅ›laÅ‚em (po przygotowaniu konfiguracji pod testy, trafiÅ‚em na podobne rozwiÄ…zanie na stacku).
StworzyÅ‚em klasÄ™ umoÅ¼liwiajÄ…cÄ… podniesienie potrzebnych kontenerÃ³w, aby skorzystaÄ‡ z nich podczas testÃ³w:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">"test"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestContainers</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">MONGO_PORT</span> <span class="o">=</span> <span class="mi">29019</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">AXON_HTTP_PORT</span> <span class="o">=</span> <span class="mi">8024</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">AXON_GRPC_PORT</span> <span class="o">=</span> <span class="mi">8124</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startAxonServer</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">GenericContainer</span> <span class="n">axonServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">(</span><span class="s">"axoniq/axonserver:latest"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withExposedPorts</span><span class="o">(</span><span class="no">AXON_HTTP_PORT</span><span class="o">,</span> <span class="no">AXON_GRPC_PORT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">waitingFor</span><span class="o">(</span>
                        <span class="nc">Wait</span><span class="o">.</span><span class="na">forLogMessage</span><span class="o">(</span><span class="s">".*Started AxonServer.*"</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
                <span class="o">);</span>
        <span class="n">axonServer</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span>
                <span class="s">"ENV_AXON_GRPC_PORT"</span><span class="o">,</span> 
                <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">axonServer</span><span class="o">.</span><span class="na">getMappedPort</span><span class="o">(</span><span class="no">AXON_GRPC_PORT</span><span class="o">)));</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">startMongo</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">GenericContainer</span> <span class="n">mongo</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">GenericContainer</span><span class="o">(</span><span class="s">"mongo:latest"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withExposedPorts</span><span class="o">(</span><span class="no">MONGO_PORT</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withEnv</span><span class="o">(</span><span class="s">"MONGO_INITDB_DATABASE"</span><span class="o">,</span> <span class="s">"moviekeeper"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withCommand</span><span class="o">(</span><span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"mongod --port %d"</span><span class="o">,</span> <span class="no">MONGO_PORT</span><span class="o">))</span>
                <span class="o">.</span><span class="na">waitingFor</span><span class="o">(</span>
                        <span class="nc">Wait</span><span class="o">.</span><span class="na">forLogMessage</span><span class="o">(</span><span class="s">".*waiting for connections.*"</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
                <span class="o">);</span>
        <span class="n">mongo</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span>
                <span class="s">"ENV_MONGO_PORT"</span><span class="o">,</span> 
                <span class="nc">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">mongo</span><span class="o">.</span><span class="na">getMappedPort</span><span class="o">(</span><span class="no">MONGO_PORT</span><span class="o">)));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>NaleÅ¼y tu jednak pamiÄ™taÄ‡ o tym, Å¼e <strong>withExposedPorts</strong> wystawia porty tylko <strong>wewnÄ…trz kontenera</strong>, potrzebny wiÄ™c byÅ‚ sposÃ³b na pozyskanie portÃ³w, do ktÃ³rych testy bÄ™dÄ… mogÅ‚y siÄ™ poÅ‚Ä…czyÄ‡.
Testcontainers przy kaÅ¼dym restarcie kontenera wystawia go na losowym wolnym porcie z danego zakresu, istnieje jednak metoda na pobranie tych portÃ³w w runtime.
RobiÄ™ to w ostatniej instrukcji kaÅ¼dej z metod, jednoczeÅ›nie wrzucajÄ…c znalezione wartoÅ›ci do zmiennych Å›rodowiskowych <strong>ENV_AXON_GRPC_PORT</strong> oraz <strong>ENV_MONGO_PORT</strong>.
Zmienne te uÅ¼ywam w yamlu konfiguracyjnym pod testy:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">data</span><span class="pi">:</span>
        <span class="na">mongodb</span><span class="pi">:</span>
            <span class="na">uri</span><span class="pi">:</span> <span class="s">mongodb://localhost:${ENV_MONGO_PORT}/moviekeeper</span>
<span class="na">axon</span><span class="pi">:</span>
  <span class="na">axonserver</span><span class="pi">:</span>
        <span class="na">servers</span><span class="pi">:</span> <span class="s">localhost:${ENV_AXON_GRPC_PORT}</span>
</code></pre></div></div>
<p>Metody <strong>startMongo</strong> i <strong>startAxonServer</strong> wykorzystaÅ‚em w klasie, z ktÃ³rej dziedziczÄ… wszystkie testy integracyjne:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@ExtendWith</span><span class="o">(</span><span class="nc">SpringExtension</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">webEnvironment</span> <span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">RANDOM_PORT</span><span class="o">)</span>
<span class="nd">@ActiveProfiles</span><span class="o">(</span><span class="s">"test"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommonIntegrationSetup</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@BeforeAll</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">beforeAll</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">TestContainers</span><span class="o">.</span><span class="na">startAxonServer</span><span class="o">();</span>
        <span class="nc">TestContainers</span><span class="o">.</span><span class="na">startMongo</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>Po wszystkim nie musimy zatrzymywaÄ‡ kontenerÃ³w, zadzieje siÄ™ to automatycznie (GenericContainer implementuje <code class="language-plaintext highlighter-rouge">AutoCloseable</code>).
NaleÅ¼y jednak pamiÄ™taÄ‡ o <strong>ustawieniu profilu</strong> i <strong>pliku konfiguracyjnym</strong> pod ten profil - zdarzyÅ‚o mi siÄ™ puÅ›ciÄ‡ testy (bez tych dwÃ³ch rzeczy skonfigurowanych), podczas gdy aplikacja chodziÅ‚a â€œprodukcyjnieâ€ - moÅ¼na Å‚atwo zgadnÄ…Ä‡, do jakiego AxonServera owe testy siÄ™ podÅ‚Ä…czyÅ‚y. :)</p>

<h2 id="skonfigurowane-do-dzieÅ‚a">Skonfigurowane. Do dzieÅ‚a!</h2>
<p>W mojej aplikacji w momencie, gdy znaleziony zostanie film o Å¼Ä…danym tytule, majÄ… miejsce nastÄ™pujÄ…ce kroki:</p>
<ol>
  <li>Zwracane sÄ… szczegÃ³Å‚y znalezionego filmu.</li>
  <li>WysyÅ‚any jest command, ktÃ³ry mÃ³wi <strong>znajdÅº trailery i obsadÄ™ dla tego filmu</strong>.</li>
</ol>

<p>ParÄ™ krokÃ³w pÃ³Åºniej efektem tego commanda, sÄ… kolejne commandy, juÅ¼ skierowane do konkretnego mikroserwisu (odpowiedzialnego za pobranie obsady i trailerÃ³w).
Å»eby nie byÅ‚o za Å‚atwo, wyszukiwanie czegokolwiek w TMDb zlecam osobnemu mikroserwisowi (zachÄ™cam do spojrzenia na diagram komponentÃ³w z <a href="/2020/06/09/microservices-on-axon.html">poprzedniego wpisu</a>).
OczywiÅ›cie nie chcÄ™, aby test byÅ‚ zaleÅ¼ny od jakiegoÅ› serwisu, wiÄ™c konieczne jest stworzenie mocka:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Profile</span><span class="o">(</span><span class="s">"test"</span><span class="o">)</span>
<span class="nd">@Slf4j</span>
<span class="nd">@Component</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MockProxyCommandHandler</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">EventGateway</span> <span class="n">eventGateway</span><span class="o">;</span>

    <span class="nd">@CommandHandler</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handle</span><span class="o">(</span><span class="nc">FetchTrailersCommand</span> <span class="n">command</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"MOCK fetching..."</span><span class="o">);</span>
        <span class="n">eventGateway</span><span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="k">new</span> <span class="nc">TrailersDetailsEvent</span><span class="o">(</span><span class="n">command</span><span class="o">.</span><span class="na">getProxyId</span><span class="o">(),</span> <span class="no">TRAILERS</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>W teÅ›cie chcÄ™ zasymulowaÄ‡ sytuacjÄ™, w ktÃ³rej pojawia siÄ™ command <strong>CreateTrailersCommand</strong>.
W efekcie aplikacja powinna pobraÄ‡ trailery dla wskazanego filmu i umieÅ›ciÄ‡ je w bazie:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TrailersIntegrationTest</span> <span class="kd">extends</span> <span class="nc">CommonIntegrationSetup</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="nc">CommandGateway</span> <span class="n">commandGateway</span><span class="o">;</span>
    <span class="o">...</span>

    <span class="nd">@BeforeEach</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">beforeEach</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">movieId</span> <span class="o">=</span> <span class="s">"123"</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">trailers</span> <span class="o">=</span> <span class="n">generateTrailers</span><span class="o">(</span><span class="n">movieId</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldRetrieveTrailers</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// given</span>
        <span class="n">commandGateway</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="k">new</span> <span class="nc">CreateTrailersCommand</span><span class="o">(</span>
                    <span class="n">trailers</span><span class="o">.</span><span class="na">getAggregateId</span><span class="o">(),</span> 
                    <span class="n">trailers</span><span class="o">.</span><span class="na">getExternalMovieId</span><span class="o">(),</span> 
                    <span class="n">trailers</span><span class="o">.</span><span class="na">getMovieId</span><span class="o">()));</span>

        <span class="n">await</span><span class="o">()</span>
            <span class="o">.</span><span class="na">atMost</span><span class="o">(</span><span class="no">FIVE_SECONDS</span><span class="o">)</span>
            <span class="o">.</span><span class="na">with</span><span class="o">()</span>
            <span class="o">.</span><span class="na">pollInterval</span><span class="o">(</span><span class="no">ONE_HUNDRED_MILLISECONDS</span><span class="o">)</span>
            <span class="o">.</span><span class="na">until</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">trailerRepository</span><span class="o">.</span><span class="na">findByMovieId</span><span class="o">(</span><span class="n">movieId</span><span class="o">).</span><span class="na">isPresent</span><span class="o">());</span>

        <span class="c1">// when</span>
        <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">TrailerDTO</span><span class="o">[]&gt;</span> <span class="n">trailerResponse</span> <span class="o">=</span> <span class="n">testRestTemplate</span>
                <span class="o">.</span><span class="na">getForEntity</span><span class="o">(</span>
                        <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="no">GET_TRAILERS_URL</span><span class="o">,</span> <span class="n">randomServerPort</span><span class="o">,</span> <span class="n">movieId</span><span class="o">),</span>
                        <span class="nc">TrailerDTO</span><span class="o">[].</span><span class="na">class</span><span class="o">);</span>
        <span class="c1">// then</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">trailerResponse</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">trailerResponse</span><span class="o">.</span><span class="na">getBody</span><span class="o">()).</span><span class="na">isNotNull</span><span class="o">();</span>

        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">TrailerDTO</span><span class="o">&gt;</span> <span class="n">trailerDTOS</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">trailerResponse</span><span class="o">.</span><span class="na">getBody</span><span class="o">());</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">trailerDTOS</span><span class="o">.</span><span class="na">size</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">trailerDTOS</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">trailers</span><span class="o">.</span><span class="na">getTrailers</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>SkorzystaÅ‚em z <a href="https://github.com/awaitility/awaitility"><strong>awaitility</strong></a>, Å¼eby poczekaÄ‡ chwilÄ™ na odpowiedÅº w razie maÅ‚ej czkawki.</p>

<h1 id="testy-e2e">Testy E2E</h1>
<p>Na samym szczycie piramidy testÃ³w sÄ… testy end-to-end, czyli sprawdzenie aplikacji w ten sposÃ³b, w jaki klient z niej korzysta.
W moim przypadku klientem jest aplikacja frontendowa, ktÃ³ra uderzajÄ…c na konkretny endpoint, oczekuje konkretnej odpowiedzi.
Przetestujmy wyszukanie filmu po tytule.</p>

<p>Taki test powinien:</p>
<ul>
  <li>uderzyÄ‡ na endpoint, za ktÃ³rym kryje siÄ™ dana funkcjonalnoÅ›Ä‡,</li>
  <li>sprawdziÄ‡ status odpowiedzi od serwera,</li>
  <li>sprawdziÄ‡ zawartoÅ›Ä‡ odpowiedzi,</li>
  <li>upewniÄ‡ siÄ™, Å¼e film zostaÅ‚ umieszczony w bazie, a jeÅ›li tak to czy jest on rÃ³wny temu, ktÃ³ry dostaliÅ›my w ciele odpowiedzi.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MovieE2ETest</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldStoreMovie</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// when</span>
        <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">MovieDTO</span><span class="o">&gt;</span> <span class="n">storedMovieResponse</span> <span class="o">=</span> <span class="n">testRestTemplate</span><span class="o">.</span><span class="na">postForEntity</span><span class="o">(</span>
                           <span class="nc">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="no">GET_OR_POST_MOVIES</span><span class="o">,</span> <span class="n">randomServerPort</span><span class="o">),</span> 
                           <span class="k">new</span> <span class="nf">TitleBody</span><span class="o">(</span><span class="no">SUPER_MOVIE</span><span class="o">),</span> 
                           <span class="nc">MovieDTO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="n">assertThat</span><span class="o">(</span><span class="n">storedMovieResponse</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="nc">HttpStatus</span><span class="o">.</span><span class="na">CREATED</span><span class="o">);</span>

        <span class="nc">MovieDTO</span> <span class="n">body</span> <span class="o">=</span> <span class="n">storedMovieResponse</span><span class="o">.</span><span class="na">getBody</span><span class="o">();</span>

        <span class="n">await</span><span class="o">()</span>
                <span class="o">.</span><span class="na">atMost</span><span class="o">(</span><span class="no">FIVE_SECONDS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">with</span><span class="o">()</span>
                <span class="o">.</span><span class="na">pollInterval</span><span class="o">(</span><span class="no">ONE_HUNDRED_MILLISECONDS</span><span class="o">)</span>
                <span class="o">.</span><span class="na">until</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">movieRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">body</span><span class="o">.</span><span class="na">getAggregateId</span><span class="o">()).</span><span class="na">isPresent</span><span class="o">());</span>

        <span class="c1">// then</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">body</span><span class="o">).</span><span class="na">isNotNull</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">body</span><span class="o">.</span><span class="na">getAggregateId</span><span class="o">()).</span><span class="na">isNotEmpty</span><span class="o">();</span>
        <span class="n">assertThat</span><span class="o">(</span><span class="n">body</span><span class="o">.</span><span class="na">getTitle</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="no">SUPER_MOVIE</span><span class="o">);</span>

        <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">MovieDTO</span><span class="o">&gt;</span> <span class="n">persistedMovie</span> <span class="o">=</span> <span class="n">movieRepository</span>
                    <span class="o">.</span><span class="na">findByExternalMovieId</span><span class="o">(</span><span class="n">body</span><span class="o">.</span><span class="na">getExternalMovieId</span><span class="o">());</span>
        <span class="n">persistedMovie</span><span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">movie</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="n">assertThat</span><span class="o">(</span><span class="n">movie</span><span class="o">).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="n">body</span><span class="o">);</span>
            <span class="n">assertThat</span><span class="o">(</span><span class="n">movie</span><span class="o">.</span><span class="na">getCreationDate</span><span class="o">()).</span><span class="na">isEqualTo</span><span class="o">(</span><span class="no">NOW</span><span class="o">);</span>
            <span class="n">assertThat</span><span class="o">(</span><span class="n">movie</span><span class="o">.</span><span class="na">isWatched</span><span class="o">()).</span><span class="na">isFalse</span><span class="o">();</span>
        <span class="o">});</span>
    <span class="o">}</span>
    <span class="o">...</span>
<span class="o">}</span>
</code></pre></div></div>
<p>W tym podejÅ›ciu rÃ³wnieÅ¼ wykorzystaÅ‚em kontenery testowe, tak samo, jak przy testach integracyjnych, konfiguracja jest identyczna.
Nie chcÄ™ uzaleÅ¼niaÄ‡ Å¼adnych testÃ³w od poÅ‚Ä…czenia z zewnÄ™trznym serwisem, wiÄ™c i w tym przypadku posÅ‚uÅ¼yÅ‚em siÄ™ mockiem, symulujÄ…cym dziaÅ‚anie proxy-service.</p>

<h1 id="podsumowanie">Podsumowanie</h1>
<p>Jak widaÄ‡ korzystanie z Axonowych <strong>fixture</strong> bardzo uÅ‚atwia testowanie kodu, a i w przypadku testÃ³w wymagajÄ…cych szerszego kontekstu rÃ³wnieÅ¼ istniejÄ… rozwiÄ…zania.
Uruchamianie takich testÃ³w moÅ¼na w Å‚atwy sposÃ³b zautomatyzowaÄ‡, np. uÅ¼ywajÄ…c Travisa, dziÄ™ki czemu bÄ™dziemy znali na bieÅ¼Ä…co stan naszej aplikacji.</p>

<h1 id="ÅºrÃ³dÅ‚a">Å¹rÃ³dÅ‚a</h1>
<ul>
  <li><a href="https://github.com/matty-matt/movie-keeper-core">https://github.com/matty-matt/movie-keeper-core</a></li>
</ul>
:ET