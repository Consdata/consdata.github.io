I"÷3<p>HAProxy to pakiet wolnego oprogramowania, ktÃ³ry najczÄ™Å›ciej peÅ‚ni rolÄ™ reverse-proxy, zapewniajÄ…c load-balancing i high-availability serwerÃ³w aplikacji.</p>

<p>Klienci (np. przeglÄ…darki) nie Å‚Ä…czÄ… siÄ™ bezpoÅ›rednio z serwerami aplikacji, lecz wÅ‚aÅ›nie z reverse-proxy, ktÃ³re stosujÄ…c dodatkowe reguÅ‚y przekazuje Å¼Ä…dania do serwerÃ³w aplikacji i odpowiedzi z powrotem do klienta.</p>

<p>Projekt jest aktywnie rozwijany od 2002 roku i coraz czÄ™Å›ciej wykorzystywany z powodu popularyzacji systemÃ³w rozproszonych, w szczegÃ³lnoÅ›ci architektur opartych o mikroserwisy. 
UÅ¼ywajÄ… go takie tuzy jak Digital Ocean, Github, Dropbox, Instagram, czy StackOverflow. Jest teÅ¼ komponentem platformy kontenerowej OpenShift.</p>

<p>Pakiet jest dostÄ™pny dla wszystkich popularnych dystrybucji Linuxa, a takÅ¼e w postaci obrazu Dockerowego.</p>

<h2 id="standardowe-zastosowania-haproxy">Standardowe zastosowania HAProxy.</h2>

<h3 id="zapewnienie-load-balancingu">Zapewnienie Load Balancingu</h3>
<p>Jedno z podstawowych zastosowaÅ„ HAProxy to softwareâ€™owy load-balancer. MajÄ…c kilka wÄ™zÅ‚Ã³w naszej aplikacji chcielibyÅ›my rozdzielaÄ‡ ruch pomiÄ™dzy nimi. 
W konfiguracji HAProxy deklarujemy obiekt zwany backendem, ktÃ³ry reprezentuje klaster naszych serwerÃ³w aplikacji. 
NastÄ™pnie deklarujemy obiekt zwany frontendem, na ktÃ³ry bÄ™dÄ… kierowani klienci oraz reguÅ‚y kierowania ruchu z frontendu do backendu:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend my-load-balancer
    bind 172.19.0.1:81
    default_backend my-application-servers
    
backend my-application-servers
    balance roundrobin
    server my-app-server-1 172.19.0.2:8080
    server my-app-server-2 172.19.0.3:8080
    server my-app-server-3 172.19.0.4:8080    
</code></pre></div></div>

<p>PowyÅ¼sza konfiguracja powoduje Å¼e poÅ‚Ä…czenia na endpoint 172.19.0.1:81 bÄ™dÄ… przekierowywane na jeden z trzech podanych serwerÃ³w w sposÃ³b rÃ³wnomierny.</p>

<h3 id="zapewnienie-high-availability">Zapewnienie High Availability</h3>
<p>HAProxy potrafi monitorowaÄ‡ stan serwerÃ³w zadeklarowanych w sekcji backend i zaprzestaÄ‡ kierowania ruchu na serwery, ktÃ³re przestaÅ‚y poprawnie funkcjonowaÄ‡.
W konfiguracji serwera moÅ¼emy okreÅ›liÄ‡ m.in. jak czÄ™sto HAProxy ma sprawdzaÄ‡ status serwera, ile razy weryfikacja musi siÄ™ nie udaÄ‡, Å¼eby serwer zostaÅ‚ uznany za dysfunkcyjny oraz ile
razy po wykluczeniu serwera weryfikacja musi siÄ™ powieÅ›Ä‡, Å¼eby serwer znÃ³w zostaÅ‚ uznany za â€œzdrowyâ€.
PrzykÅ‚adowo:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    server my-app-server-1 172.19.0.2:8080 check inter 5s fall 3 downinter 1m raise 5
</code></pre></div></div>
<p>oznacza Å¼e:</p>
<ul>
  <li>status serwera ma byÄ‡ sprawdzany co 5 sekund (<em>inter 5s</em>)</li>
  <li>serwer ma zostaÄ‡ wykluczony jeÅ›li nie powiodÄ… siÄ™ 3 kolejne sprawdzenia (<em>fall 3</em>)</li>
  <li>wykluczony serwer ma byÄ‡ sprawdzany co minutÄ™ (<em>downinter 1m</em>)</li>
  <li>serwer ma zostaÄ‡ ponownie uznany za sprawny jeÅ›li powiedzie siÄ™ kolejne 5 sprawdzeÅ„ (<em>raise 5</em>)</li>
</ul>

<h3 id="tlsssl">TLS/SSL</h3>
<p>JeÅ¼eli chodzi o obsÅ‚ugÄ™ szyfrowanych poÅ‚Ä…czeÅ„ TLS/SSL, HAProxy moÅ¼e dziaÅ‚aÄ‡ w jednym z trybÃ³w:</p>
<ul>
  <li>zwykÅ‚e proxy</li>
  <li>terminacja szyfrowania</li>
  <li>ponowne szyfrowanie ruchu</li>
</ul>

<h4 id="zwykÅ‚e-proxy">ZwykÅ‚e proxy</h4>
<p>W tym trybie HAProxy zwyczajnie przekazuje strumieÅ„ bajtÃ³w z frontendu do backendu, nie wnikajÄ…c w to, Å¼e ruch jest szyfrowany.</p>

<h4 id="terminacja-szyfrowania">Terminacja szyfrowania</h4>
<p>W tym trybie HAProxy otrzymuje szyfrowany ruch z frontendu, odszyfrowuje go (z uÅ¼yciem klucza prywatnego) i przekazuje do backendu w postaci niezaszyfrowanej. 
PrzykÅ‚adowa konfiguracja:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend my-terminating-load-balancer
    bind 172.19.0.1:443 ssl crt /etc/ssl/certs/my-certs.pem
    default_backend my-application-servers
    
backend my-application-servers
    balance roundrobin
    server my-app-server-1 172.19.0.2:8080
    server my-app-server-2 172.19.0.3:8080
</code></pre></div></div>

<h4 id="ponowne-szyfrowanie-ruchu">Ponowne szyfrowanie ruchu</h4>
<p>W tym trybie HAProxy otrzymuje szyfrowany ruch z frontendu, odszyfrowuje go (z uÅ¼yciem klucza prywatnego), a nastÄ™pnie szyfruje ponownie i przekazuje do backendu. 
PrzykÅ‚adowa konfiguracja:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend my-terminating-load-balancer
    bind 172.19.0.1:443 ssl crt /etc/ssl/certs/my-certs.pem
    default_backend my-secure-application-servers
    
backend my-secure-application-servers
    balance roundrobin
    server my-secure-app-server-1 172.19.0.2:8443 ssl
    server my-secure-app-server-2 172.19.0.3:8443 ssl
</code></pre></div></div>
<p>W odrÃ³Å¼nieniu od trybu zwykÅ‚ego proxy, dziÄ™ki odszyfrowaniu HAProxy moÅ¼e manipulowaÄ‡ Å¼Ä…daniami HTTP, ktÃ³re przekierowuje.</p>

<h3 id="session-affinity">Session affinity</h3>
<p>HAProxy pozwala na takÄ… konfiguracjÄ™, Å¼e requesty od danego uÅ¼ytkownika zawsze bÄ™dÄ… kierowane na ten sam serwer aplikacji. 
Taka potrzeba zachodzi m.in. kiedy uÅ¼ywamy lokalnych sesji uÅ¼ytkownika, ktÃ³re istniejÄ… tylko na tym serwerze aplikacji, na ktÃ³rym zostaÅ‚y utworzone.
PrzykÅ‚adowa konfiguracja, ktÃ³ra opiera siÄ™ na prefiksie ciasteczka sesyjnego:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend my-sticky-load-balancer
    bind 172.19.0.1:81 
    default_backend my-application-servers
    
backend my-application-servers
    cookie JSESSIONID prefix nocache
    server my-app-server-1 172.19.0.2:8080 cookie node1
    server my-app-server-2 172.19.0.3:8080 cookie node2
</code></pre></div></div>
<p>Przy takiej konfiguracji wszystkie requesty, ktÃ³re niosÄ… ciasteczko sesyjne z prefiksem â€œnode1â€ bÄ™dÄ… kierowane na pierwszy serwer aplikacji.</p>

<h3 id="acl">ACL</h3>
<p>HAProxy pozwala konfigurowaÄ‡ reguÅ‚y (ACL - Access Control List), ktÃ³re okreÅ›lajÄ… w jaki sposÃ³b poszczegÃ³lne Å¼Ä…dania majÄ… byÄ‡ obsÅ‚ugiwane. 
PrzykÅ‚adowa konfiguracja:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend my-acl-load-balancer
    bind 172.19.0.1:81 
    acl is-passive method GET
    use_backend my-passive-application-server if is-passive
    default_backend my-active-application-server
    
backend my-passive-application-server
    server my-passive-app-server-1 172.19.0.2:8080 
    
backend my-active-application-server
    server my-active-app-server-1 172.19.0.3:8080 
</code></pre></div></div>
<p>Przy takiej konfiguracji Å¼Ä…dania z metodÄ… GET bÄ™dÄ… kierowane na pasywny serwer aplikacji, a wszystkie pozostaÅ‚e na aktywny serwer aplikacji.</p>

<h2 id="zastosowania-w-warsztacie-programistycznym">Zastosowania w warsztacie programistycznym</h2>
<p>Poza klasycznym uÅ¼yciem jako reverse-proxy zapewniajÄ…ce load-balancing i high-availability, HAProxy moÅ¼e byÄ‡ z powodzeniem wykorzystane w warsztacie programistycznym. 
PrzedstawiÄ™ poniÅ¼ej kilka zastosowaÅ„ z wÅ‚asnego doÅ›wiadczenia.</p>

<h3 id="routing-ktÃ³ry-Å‚atwo-zmieniÄ‡">Routing, ktÃ³ry Å‚atwo zmieniÄ‡</h3>
<p>RozwijajÄ…c aplikacjÄ™, ktÃ³ra wywoÅ‚uje serwisy z innych aplikacji, chcemy niekiedy mÃ³c przeÅ‚Ä…czaÄ‡ siÄ™ miÄ™dzy rÃ³Å¼nymi adresami tych zewnÄ™trznych usÅ‚ug, 
np. moÅ¼emy chcieÄ‡ sprawnie przeÅ‚Ä…czaÄ‡ siÄ™ miÄ™dzy prawdziwymi aplikacjami oraz ich zmockowanymi wersjami. 
CzÄ™sto restart naszej aplikacji jest dÅ‚ugotrwaÅ‚y, a zmiana namiarÃ³w na zewnÄ™trzne usÅ‚ugi wymaga edycji wiÄ™cej niÅ¼ jednego pliku.
W takim przypadku HAProxy moÅ¼e nam posÅ‚uÅ¼yÄ‡ jako wygodna â€œcentralkaâ€, w ktÃ³rej bÄ™dziemy siÄ™ sprawnie przeÅ‚Ä…czaÄ‡ miÄ™dzy rÃ³Å¼nymi wersjami zewnÄ™trznych usÅ‚ug.
KonfigurujÄ…c HAProxy w ten sposÃ³b:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend my-forward-proxy
    bind 172.19.0.1:81
    default_backend my-external-services
    
backend my-external-services
    server my-external-server-1 172.19.0.2:8080

backend my-mocked-services
    server my-mocked-server-1 172.19.0.3:8080
</code></pre></div></div>
<p>i ustawiajÄ…c w naszej aplikacji adres zewnÄ™trznych usÅ‚ug na 172.19.0.1:81, 
moÅ¼emy bez restartu aplikacji zmieniaÄ‡ jej zewnÄ™trzne zaleÅ¼noÅ›ci przez zmianÄ™ wartoÅ›ci â€œdefault_backendâ€ i szybki â€œreloadâ€ HAProxy.</p>

<h3 id="podglÄ…danie-tlsssl">PodglÄ…danie TLS/SSL</h3>
<p>JeÅ›li serwisy w naszym systemie przesyÅ‚ajÄ… sobie dane przez szyfrowane poÅ‚Ä…czenia TLS/SSL, moÅ¼e to stanowiÄ‡ przeszkodÄ™ w debugowaniu komunikacji przy pomocy analizatorÃ³w ruchu sieciowego, 
takich jak tcpdump, czy Wireshark. 
MoÅ¼emy jednak pomiÄ™dzy serwisami ustawiÄ‡ poÅ›rednika w postaci HAProxy, ktÃ³re bÄ™dzie terminowaÅ‚o szyfrowane poÅ‚Ä…czenie i umoÅ¼liwiaÅ‚o nam podglÄ…danie ruchu sieciowego.</p>

<h3 id="opÃ³Åºnienia-requestÃ³w">OpÃ³Åºnienia requestÃ³w</h3>
<p>Podczas rozwijania aplikacji zachodzi czasem potrzeba przetestowania jak zachowa siÄ™ ona w przypadku dÅ‚uÅ¼szego niÅ¼ oczekiwane przetwarzania w wywoÅ‚ywanych usÅ‚ugach zewnÄ™trznych.
JeÅ›li poÅ›rednikiem w dostÄ™pie do zewnÄ™trznych usÅ‚ug jest HAProxy, to mamy moÅ¼liwoÅ›Ä‡ zasymulowania takiego opÃ³Åºnienia.
HAProxy samo w sobie nie posiada takiej funkcjonalnoÅ›ci, ale pozwala na rozszerzanie moÅ¼liwoÅ›ci za pomocÄ… skryptÃ³w pisanych w jÄ™zyku Lua.
PrzykÅ‚adowy skrypt dodajÄ…cy opÃ³Åºnienie:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>function delay_request(txn)
    core.msleep(15000)
end

core.register_action("delay_request", { "http-req" }, delay_request);
</code></pre></div></div>
<p>ZaÅ‚adowanie skryptu do HAProxy:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    lua-load /etc/haproxy/delay.lua
</code></pre></div></div>
<p>i uÅ¼ycie w konfiguracji:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend my-delay-frontend
    bind 172.19.0.1:81
    mode http
    http-request lua.delay_request
    default_backend my-delay-backend

backend my-delay-backend
    server my-external-server-1 172.19.0.2:8080
</code></pre></div></div>
<h3 id="prosty-serwer-statycznej-zawartoÅ›ci">Prosty serwer statycznej zawartoÅ›ci</h3>
<p>W doÅ›Ä‡ przewrotny sposÃ³b moÅ¼emy wykorzystaÄ‡ HAProxy jako prosty serwer statycznych plikÃ³w. 
Dla kaÅ¼dego backendu moÅ¼emy skonfigurowaÄ‡ pliki, ktÃ³re majÄ… zostaÄ‡ zaserwowane w przypadku okreÅ›lonych statusÃ³w HTTP.
Z drugiej strony, w przypadku gdy w konfiguracji backendu nie zdefiniowano Å¼adnego serwera, HAProxy generuje status HTTP 503.
ÅÄ…czÄ…c te dwa fakty moÅ¼emy skonfigurowaÄ‡ frontend, ktÃ³ry dla okreÅ›lonych requestÃ³w bÄ™dzie zwracaÅ‚ statyczny plik:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend my-frontend
    bind 172.19.0.1:81
    mode http
    use_backend my-backend-static if { path_end /index.html }
    default_backend my-backend-services

backend my-backend-static
    mode http
    errorfile 503 /etc/haproxy/index.html
    
backend my-backend-services
    server my-external-server-1 172.19.0.2:8080
</code></pre></div></div>

<h3 id="podÅ‚Ä…czanie-siÄ™-do-sesji">PodÅ‚Ä…czanie siÄ™ do sesji</h3>
<p>W Å›rodowisku deweloperskim zdarza siÄ™, Å¼e chcielibyÅ›my podÅ‚Ä…czyÄ‡ siÄ™ przeglÄ…darkÄ… do istniejÄ…cej na serwerze sesji uÅ¼ytkownika (znajÄ…c oczywiÅ›cie identyfikator/token sesji).
Nowoczesne desktopowe przeglÄ…darki zazwyczaj pozwalajÄ… nam rÄ™cznie dodaÄ‡ ciasteczko sesyjne do zbioru ciasteczek danej witryny. 
Co jednak, jeÅ›li musimy obsÅ‚uÅ¼yÄ‡ rÃ³wnieÅ¼ te mniej lubiane przeglÄ…darki albo wersje mobilne? Tu z pomocÄ… rÃ³wnieÅ¼ moÅ¼e przyjÅ›Ä‡ nam HAProxy:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>frontend my-setcookie-frontend
    bind 172.19.0.1:81
    mode http
    default_backend my-setcookie-backend

backend my-setcookie-backend
    mode http
    http-request redirect location http://172.19.0.1:80/\r\nSet-Cookie:\ JSESSIONID=%[urlp(session_id)] code 302
</code></pre></div></div>
<p>Przy takiej konfiguracji, wejÅ›cie z dowolnej przeglÄ…darki na adres http://172.19.0.1:81/?session_id=123456 spowoduje przekierowanie na http://172.19.0.1:80 z ustawionym juÅ¼ ciasteczkiem sesyjnym 
(wykorzystujemy tu fakt Å¼e ciasteczka ustawione dla domeny nie uwzglÄ™dniajÄ… portÃ³w).</p>

<h2 id="podsumowanie">Podsumowanie</h2>
<p>Jak widaÄ‡, HAProxy ma wiele klasycznych i mniej klasycznych zastosowaÅ„.</p>

<p>Jego niewÄ…tpliwym atutem jest stosunkowo prosta konfiguracja i runtimeâ€™owa wydajnoÅ›Ä‡ oraz â€œlekkoÅ›Ä‡â€ (zaczytanie zmienionej konfiguracji odbywa siÄ™ zwykle w uÅ‚amku sekundy).</p>

<p>Jest to narzÄ™dzie, ktÃ³re polecam do toolboxa kaÅ¼dego architekta systemÃ³w rozproszonych, a takÅ¼e do warsztatu deweloperskiego zwinnego programisty.</p>
:ET